# Workspace Files Reference

Each nous has a workspace directory (`nous/<name>/`) containing up to 9 markdown files that form its identity, memory, and runtime context. The bootstrap system (`src/nous/bootstrap.ts`) reads these files, applies token budgeting, and assembles them into the system prompt for every API call.

---

## Files

| File | Priority | Cache Group | Required | Source | Purpose |
|------|----------|-------------|----------|--------|---------|
| SOUL.md | 1 | static | Yes | Hand-written | Core identity, principles, communication style, boundaries |
| USER.md | 2 | static | No | Hand-written | Operator profile, preferences, goals, constraints |
| AGENTS.md | 3 | static | No | Hand-written | Other nous in the system, collaboration protocols, routing |
| IDENTITY.md | 4 | static | Yes | Hand-written | Minimal metadata: name, emoji. Parsed as frontmatter |
| GOALS.md | 4.5 | semi-static | No | Hand-written | Active, completed, and deferred goals |
| TOOLS.md | 5 | semi-static | No | Auto-generated | Tool inventory and profiles. Regenerated when tool set changes |
| MEMORY.md | 6 | semi-static | No | Nous-maintained | Long-term curated knowledge: facts, preferences, patterns, lessons |
| PROSOCHE.md | 7 | dynamic | No | Auto-generated | Adaptive attention directives from the prosoche daemon |
| CONTEXT.md | 8 | dynamic | No | Runtime-written | Transient session-scoped state, cleared at session boundaries |

---

## Load Order and Priority

Files are loaded in strict priority order (1 = highest). The priority number determines two things:

1. **System prompt ordering.** Lower priority number = earlier in the system prompt. SOUL.md is always first.
2. **Drop order under budget pressure.** When total tokens exceed the budget, the loader drops files from the bottom (highest priority number) first. CONTEXT.md and PROSOCHE.md are dropped before MEMORY.md, which is dropped before TOOLS.md, and so on. SOUL.md is the last file that would ever be dropped.

If a file does not exist in the workspace directory, it is silently skipped. Empty files are also skipped.

---

## Required vs Optional

Only two files are truly required for a nous to function:

- **SOUL.md** -- Without it, the nous has no identity or behavioral guidance.
- **IDENTITY.md** -- Provides the name and emoji used for routing and display.

All other files are optional. A minimal nous needs only these two. In practice, most nous also have AGENTS.md (for multi-agent coordination) and MEMORY.md (for session continuity).

---

## Hand-Written vs Auto-Generated

**Hand-written by the operator:**
- SOUL.md, USER.md, AGENTS.md, IDENTITY.md, GOALS.md

**Maintained by the nous itself:**
- MEMORY.md -- The nous reads and updates this file across sessions to build persistent knowledge. The template instructs the nous: "Your workspace files are your memory. Update them proactively."

**Auto-generated by the runtime:**
- TOOLS.md -- Generated by a `generate-tools-md` script when the tool set changes. Do not edit manually.
- PROSOCHE.md -- Written by the prosoche daemon based on calendar signals, pending tasks, and cross-nous messages.
- CONTEXT.md -- Written by the runtime with transient session state. Cleared or overwritten at session boundaries.

---

## Token Budget

The bootstrap system enforces a configurable token budget (default: 40,000 tokens, set via `bootstrapMaxTokens` in `aletheia.json`).

**Budget enforcement algorithm:**

1. Load all existing workspace files and estimate token counts.
2. Sort by priority (ascending).
3. Include files sequentially until budget is exhausted.
4. If adding the next file would exceed the budget and at least 500 tokens remain, truncate that file section-aware (splits on `## ` headers, preserving complete sections). If fewer than 500 tokens remain, drop the file entirely.
5. All remaining lower-priority files are dropped.
6. Dropped files are logged as warnings and recorded in `BootstrapResult.droppedFiles`.

**Token budget partitioning (in manager.ts):**

The bootstrap budget is one piece of the total context window (`contextTokens`, default 200,000):

```
historyBudget = contextTokens - bootstrapTokens - toolDefTokens - maxOutputTokens
```

This means large workspace files directly reduce the token space available for conversation history. Keep workspace files concise.

---

## Cache Groups and Anthropic Prefix Caching

The bootstrap assembler organizes files into three cache groups to optimize Anthropic's prompt caching. Files within the same group are concatenated into a single system block. Cache breakpoints (`cache_control: { type: "ephemeral" }`) are placed after each cached group.

### Static (cached, breakpoint after)

Files: SOUL.md, USER.md, AGENTS.md, IDENTITY.md

These files rarely change. They are combined into one text block with a cache breakpoint at the end. On subsequent turns within the same session, Anthropic can serve this block from cache, saving input token costs.

**When cache invalidates:** Any edit to any static file changes the block content, invalidating the cache for all static files.

### Semi-Static (cached, breakpoint after)

Files: GOALS.md, TOOLS.md, MEMORY.md (plus injected skills section if present)

These files change occasionally -- when the nous updates its memory, when goals shift, or when tools are added/removed. Combined into a second text block with its own cache breakpoint.

**When cache invalidates:** Any edit to any semi-static file, or a change to the skills section.

### Dynamic (never cached)

Files: PROSOCHE.md, CONTEXT.md (plus degraded-service notices if any services are down)

These files change every turn or every session. Each is emitted as a separate text block with no cache control. The runtime also injects infrastructure status notices into this group when the watchdog detects unhealthy services.

---

## Additional Injection Points

Beyond the 9 workspace files, the bootstrap accepts:

- **`skillsSection`** -- Injected into the semi-static group. Contains skill definitions loaded from `shared/skills/*/SKILL.md` by the SkillRegistry.
- **`extraFiles`** -- Arbitrary additional files from the workspace, loaded at priority 10 in the dynamic group.
- **`degradedServices`** -- Service names from the watchdog. Rendered as an "Infrastructure Status" block prepended to the dynamic group with per-service degradation guidance.

---

## Bootstrap Diff Tracking

The system tracks per-file content hashes across turns (`bootstrap-diff.ts`). When a workspace file changes between turns, the diff is logged to `shared/status/bootstrap-changes.jsonl`. This enables observability into which files are changing and how often, which is useful for diagnosing cache invalidation or unexpected workspace mutations.

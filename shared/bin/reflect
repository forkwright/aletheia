#!/usr/bin/env bash
set -a
source /mnt/ssd/aletheia/shared/config/aletheia.env
set +a 2>/dev/null || true
# reflect - Generate entity pages from facts.jsonl
# Updates memory/entities/*.md with synthesized facts per entity

set -euo pipefail

FACTS_FILE="${FACTS_FILE:-${ALETHEIA_NOUS:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/nous}/syn/memory/facts.jsonl}"
ENTITIES_DIR="${ENTITIES_DIR:-${ALETHEIA_NOUS:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/nous}/syn/memory/entities}"

usage() {
    cat <<EOF
Usage: reflect [options] [entity]

Generate entity pages from facts.jsonl

Options:
  -l, --list         List all entities with fact counts
  -e, --entity NAME  Generate page for specific entity
  -a, --all          Generate pages for all entities
  -s, --stats        Show statistics
  -h, --help         Show this help

Examples:
  reflect --list              # List all entities
  reflect --entity cody       # Generate cody.md
  reflect --all               # Generate all entity pages
  reflect --stats             # Show fact statistics
EOF
    exit 0
}

list_entities() {
    if [[ ! -f "$FACTS_FILE" ]]; then
        echo "No facts file found at $FACTS_FILE"
        exit 1
    fi
    
    echo "=== Entities by Fact Count ==="
    jq -r '.subject' "$FACTS_FILE" 2>/dev/null | sort | uniq -c | sort -rn | head -20
}

show_stats() {
    if [[ ! -f "$FACTS_FILE" ]]; then
        echo "No facts file found"
        exit 1
    fi
    
    local total=$(jq -s 'length' "$FACTS_FILE" 2>/dev/null || echo 0)
    local entities=$(jq -r '.subject' "$FACTS_FILE" 2>/dev/null | sort -u | wc -l)
    local categories=$(jq -r '.category // "uncategorized"' "$FACTS_FILE" 2>/dev/null | sort -u | wc -l)
    local avg_confidence=$(jq -s '[.[].confidence // 1] | add / length * 100 | floor / 100' "$FACTS_FILE" 2>/dev/null || echo "N/A")
    
    echo "=== Facts Statistics ==="
    echo "Total facts: $total"
    echo "Unique entities: $entities"
    echo "Categories: $categories"
    echo "Average confidence: $avg_confidence"
    echo ""
    echo "=== By Category ==="
    jq -r '.category // "uncategorized"' "$FACTS_FILE" 2>/dev/null | sort | uniq -c | sort -rn
    echo ""
    echo "=== By Confidence ==="
    jq -r '.confidence // 1 | . * 10 | floor / 10 | tostring' "$FACTS_FILE" 2>/dev/null | sort | uniq -c | sort -rn
}

generate_entity_page() {
    local entity="$1"
    local output_file="$ENTITIES_DIR/${entity}.md"
    
    # Get all facts for this entity
    local facts=$(jq -r --arg e "$entity" 'select(.subject == $e)' "$FACTS_FILE" 2>/dev/null)
    
    if [[ -z "$facts" ]]; then
        echo "No facts found for entity: $entity"
        return 1
    fi
    
    local fact_count=$(echo "$facts" | jq -s 'length')
    local categories=$(echo "$facts" | jq -rs '[.[].category // "uncategorized"] | unique | join(", ")')
    local avg_conf=$(echo "$facts" | jq -s '[.[].confidence // 1] | add / length * 100 | floor')
    
    cat > "$output_file" <<EOF
# ${entity^}
*Auto-generated entity page from facts.jsonl*
*Last updated: $(date -Iseconds)*

## Summary
- **Facts:** $fact_count
- **Categories:** $categories
- **Average Confidence:** ${avg_conf}%

## Facts

EOF

    # Group by category
    echo "$facts" | jq -rs '
        group_by(.category // "uncategorized") | 
        .[] | 
        "### " + (.[0].category // "uncategorized") + "\n" +
        ([.[] | "- **" + .predicate + ":** " + .object + " _(c=" + ((.confidence // 1) * 100 | floor | tostring) + "%)_"] | join("\n")) + "\n"
    ' >> "$output_file"
    
    # Add evidence section if any facts have sources
    local with_sources=$(echo "$facts" | jq -rs '[.[] | select(.source_file != null)] | length')
    if [[ "$with_sources" -gt 0 ]]; then
        cat >> "$output_file" <<EOF

## Sources
EOF
        echo "$facts" | jq -rs '[.[] | select(.source_file != null) | .source_file] | unique | .[] | "- " + .' >> "$output_file"
    fi
    
    echo "Generated: $output_file ($fact_count facts)"
}

generate_all() {
    if [[ ! -f "$FACTS_FILE" ]]; then
        echo "No facts file found"
        exit 1
    fi
    
    local entities=$(jq -r '.subject' "$FACTS_FILE" 2>/dev/null | sort -u)
    local count=0
    
    for entity in $entities; do
        # Skip very short entity names or IDs
        if [[ ${#entity} -gt 2 ]] && [[ ! "$entity" =~ ^fact- ]]; then
            generate_entity_page "$entity" && ((count++)) || true
        fi
    done
    
    echo ""
    echo "Generated $count entity pages in $ENTITIES_DIR"
}

# Parse arguments
if [[ $# -eq 0 ]]; then
    usage
fi

while [[ $# -gt 0 ]]; do
    case "$1" in
        -l|--list)
            list_entities
            exit 0
            ;;
        -s|--stats)
            show_stats
            exit 0
            ;;
        -e|--entity)
            shift
            generate_entity_page "$1"
            exit 0
            ;;
        -a|--all)
            generate_all
            exit 0
            ;;
        -h|--help)
            usage
            ;;
        *)
            # Assume it's an entity name
            generate_entity_page "$1"
            exit 0
            ;;
    esac
    shift
done

#!/usr/bin/env python3
"""
Office document CLI - Extract and manipulate pptx/xlsx/docx files.
Usage: office <command> <file> [options]
"""

import argparse
import json
import sys
from pathlib import Path


def extract_pptx(filepath: str, output_format: str = "text") -> None:
    """Extract text from PowerPoint file."""
    try:
        from pptx import Presentation
    except ImportError:
        print("Error: python-pptx not installed. Run: pip install python-pptx", file=sys.stderr)
        sys.exit(1)
    
    prs = Presentation(filepath)
    slides_data = []
    
    for i, slide in enumerate(prs.slides, 1):
        slide_text = []
        for shape in slide.shapes:
            if hasattr(shape, "text") and shape.text.strip():
                slide_text.append(shape.text.strip())
        
        if output_format == "json":
            slides_data.append({"slide": i, "text": slide_text})
        else:
            if slide_text:
                print(f"--- Slide {i} ---")
                print("\n".join(slide_text))
                print()
    
    if output_format == "json":
        print(json.dumps(slides_data, indent=2))


def extract_xlsx(filepath: str, sheet: str = None, output_format: str = "text") -> None:
    """Extract data from Excel file."""
    try:
        from openpyxl import load_workbook
    except ImportError:
        print("Error: openpyxl not installed. Run: pip install openpyxl", file=sys.stderr)
        sys.exit(1)
    
    wb = load_workbook(filepath, read_only=True, data_only=True)
    
    if sheet:
        sheets = [wb[sheet]] if sheet in wb.sheetnames else []
        if not sheets:
            print(f"Error: Sheet '{sheet}' not found. Available: {wb.sheetnames}", file=sys.stderr)
            sys.exit(1)
    else:
        sheets = wb.worksheets
    
    all_data = {}
    
    for ws in sheets:
        rows = []
        for row in ws.iter_rows(values_only=True):
            # Skip completely empty rows
            if any(cell is not None for cell in row):
                rows.append([str(cell) if cell is not None else "" for cell in row])
        
        if output_format == "json":
            all_data[ws.title] = rows
        else:
            print(f"--- Sheet: {ws.title} ---")
            for row in rows[:50]:  # Limit output
                print("\t".join(row))
            if len(rows) > 50:
                print(f"... ({len(rows) - 50} more rows)")
            print()
    
    if output_format == "json":
        print(json.dumps(all_data, indent=2))


def list_sheets(filepath: str) -> None:
    """List sheets in Excel file."""
    try:
        from openpyxl import load_workbook
    except ImportError:
        print("Error: openpyxl not installed", file=sys.stderr)
        sys.exit(1)
    
    wb = load_workbook(filepath, read_only=True)
    for name in wb.sheetnames:
        print(name)


def list_slides(filepath: str) -> None:
    """List slides in PowerPoint file."""
    try:
        from pptx import Presentation
    except ImportError:
        print("Error: python-pptx not installed", file=sys.stderr)
        sys.exit(1)
    
    prs = Presentation(filepath)
    for i, slide in enumerate(prs.slides, 1):
        # Try to get slide title
        title = ""
        for shape in slide.shapes:
            if shape.has_text_frame and shape.text.strip():
                title = shape.text.strip()[:60]
                break
        print(f"{i}: {title or '(no title)'}")


def convert_file(filepath: str, output_format: str) -> None:
    """Convert file using LibreOffice."""
    import subprocess
    
    outdir = Path(filepath).parent
    result = subprocess.run(
        ["libreoffice", "--headless", "--convert-to", output_format, "--outdir", str(outdir), filepath],
        capture_output=True, text=True
    )
    
    if result.returncode == 0:
        print(f"Converted to {output_format}")
    else:
        print(f"Error: {result.stderr}", file=sys.stderr)
        sys.exit(1)


def main():
    parser = argparse.ArgumentParser(description="Office document CLI")
    subparsers = parser.add_subparsers(dest="command", required=True)
    
    # Extract command
    extract = subparsers.add_parser("extract", help="Extract text from document")
    extract.add_argument("file", help="Input file (pptx, xlsx, docx)")
    extract.add_argument("--sheet", "-s", help="Specific sheet (xlsx only)")
    extract.add_argument("--json", "-j", action="store_true", help="Output as JSON")
    
    # List command
    list_cmd = subparsers.add_parser("list", help="List sheets/slides")
    list_cmd.add_argument("file", help="Input file")
    
    # Convert command
    convert = subparsers.add_parser("convert", help="Convert file format")
    convert.add_argument("file", help="Input file")
    convert.add_argument("--to", "-t", required=True, help="Output format (pdf, txt, csv, html)")
    
    # Info command
    info = subparsers.add_parser("info", help="Show file info")
    info.add_argument("file", help="Input file")
    
    args = parser.parse_args()
    filepath = args.file
    
    if not Path(filepath).exists():
        print(f"Error: File not found: {filepath}", file=sys.stderr)
        sys.exit(1)
    
    ext = Path(filepath).suffix.lower()
    
    if args.command == "extract":
        fmt = "json" if args.json else "text"
        if ext in [".pptx", ".ppt"]:
            extract_pptx(filepath, fmt)
        elif ext in [".xlsx", ".xls"]:
            extract_xlsx(filepath, args.sheet, fmt)
        else:
            print(f"Unsupported format: {ext}", file=sys.stderr)
            sys.exit(1)
    
    elif args.command == "list":
        if ext in [".pptx", ".ppt"]:
            list_slides(filepath)
        elif ext in [".xlsx", ".xls"]:
            list_sheets(filepath)
        else:
            print(f"Unsupported format: {ext}", file=sys.stderr)
            sys.exit(1)
    
    elif args.command == "convert":
        convert_file(filepath, args.to)
    
    elif args.command == "info":
        print(f"File: {filepath}")
        print(f"Size: {Path(filepath).stat().st_size:,} bytes")
        print(f"Type: {ext}")
        if ext in [".xlsx", ".xls"]:
            from openpyxl import load_workbook
            wb = load_workbook(filepath, read_only=True)
            print(f"Sheets: {len(wb.sheetnames)}")
        elif ext in [".pptx", ".ppt"]:
            from pptx import Presentation
            prs = Presentation(filepath)
            print(f"Slides: {len(prs.slides)}")


if __name__ == "__main__":
    main()

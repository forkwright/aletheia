#!/usr/bin/env bash
source /mnt/ssd/aletheia/shared/config/aletheia.env 2>/dev/null || true
set -euo pipefail

# MBA CLI - Gold standard management for Syn
# Usage: mba <command> [args]

ALETHEIA_ROOT="${ALETHEIA_ROOT:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}}"
MBA_DIR="$ALETHEIA_ROOT/clawd/mba"
METIS_DIR="ck@192.168.0.17:~/dianoia/chrematistike"
TW="$ALETHEIA_ROOT/clawd/bin/tw"

case "${1:-status}" in
    status)
        echo "=== MBA System Status ==="
        echo ""
        echo "ðŸ“š Current Semester: SP26"
        echo ""
        echo "ðŸ“‹ Upcoming Tasks:"
        $TW project:mba or project:capstone limit:5 2>/dev/null | tail -n +4 | head -10
        echo ""
        echo "â° Due This Week:"
        $TW project:mba or project:capstone due.before:eow 2>/dev/null | tail -n +4 | head -10
        echo ""
        echo "ðŸ“ Last Sync: $(cat "$MBA_DIR/.last-sync" 2>/dev/null || echo 'never')"
        ;;
    
    sync)
        echo "Syncing from Metis..."
        
        # Check if Metis is reachable
        if ! ssh -o ConnectTimeout=5 ck@192.168.0.17 'echo ok' &>/dev/null; then
            echo "âŒ Metis not reachable"
            exit 1
        fi
        
        # Sync SP26
        echo "  â†’ sp26/acf..."
        rsync -az --delete "$METIS_DIR/sp26/advanced_corporate_finance/" "$MBA_DIR/sp26/acf/"
        
        echo "  â†’ sp26/strategic_mgmt..."
        rsync -az --delete "$METIS_DIR/sp26/strategic_management/" "$MBA_DIR/sp26/strategic_mgmt/"
        
        echo "  â†’ sp26/macro..."
        rsync -az --delete "$METIS_DIR/sp26/managerial_macroeconomics/" "$MBA_DIR/sp26/macro/"
        
        echo "  â†’ sp26/capstone..."
        rsync -az --delete "$METIS_DIR/sp26/capstone/" "$MBA_DIR/sp26/capstone/"
        
        # Sync FA25 (reference only)
        echo "  â†’ fa25 (reference)..."
        rsync -az "$METIS_DIR/fa25/" "$MBA_DIR/fa25/"
        
        # Record sync time
        date > "$MBA_DIR/.last-sync"
        echo "âœ“ Sync complete: $(date)"
        ;;
    
    tasks)
        $TW project:mba or project:capstone
        ;;
    
    upcoming)
        DAYS="${2:-14}"
        $TW project:mba or project:capstone due.before:now+"${DAYS}"d
        ;;
    
    prep)
        CLASS="${2:-}"
        if [ -z "$CLASS" ]; then
            echo "Usage: mba prep <class>"
            echo "Classes: acf, strategic_mgmt, macro, capstone"
            exit 1
        fi
        
        echo "Generating prep materials for: $CLASS"
        case "$CLASS" in
            acf)
                echo "ðŸ“– Advanced Corporate Finance"
                echo "Materials: $MBA_DIR/sp26/acf/"
                ls "$MBA_DIR/sp26/acf/" 2>/dev/null || echo "(not synced yet)"
                ;;
            strategic_mgmt|strat)
                echo "ðŸ“– Strategic Management"
                echo "Materials: $MBA_DIR/sp26/strategic_mgmt/"
                ls "$MBA_DIR/sp26/strategic_mgmt/" 2>/dev/null || echo "(not synced yet)"
                ;;
            macro)
                echo "ðŸ“– Managerial Macroeconomics"
                echo "Materials: $MBA_DIR/sp26/macro/"
                ls "$MBA_DIR/sp26/macro/" 2>/dev/null || echo "(not synced yet)"
                ;;
            capstone)
                echo "ðŸ“– TBC Capstone"
                head -50 "$MBA_DIR/sp26/capstone/PROJECT_STATUS.md" 2>/dev/null || echo "(not synced yet)"
                ;;
            *)
                echo "Unknown class: $CLASS"
                exit 1
                ;;
        esac
        ;;
    
    overdue)
        $TW project:mba or project:capstone +OVERDUE
        ;;
    
    drive)
        # Show what's on School Google Drive (read-only reference)
        echo "=== School Google Drive (READ-ONLY) ==="
        rclone lsd gdrive-school:TEMBA/ 2>/dev/null
        ;;
    
    help|--help|-h)
        cat << 'HELP'
MBA CLI - Gold standard management

Commands:
  status      Show current status, upcoming tasks
  sync        Sync from Metis
  tasks       Show all MBA tasks
  upcoming N  Show tasks due in N days (default 14)
  prep CLASS  Show prep materials for class (acf, strategic_mgmt, macro, capstone)
  overdue     Show overdue tasks
  drive       Show School Google Drive contents (read-only)
  help        Show this help

Examples:
  mba sync
  mba prep acf
  mba upcoming 7
HELP
        ;;
    
    *)
        echo "Unknown command: $1"
        echo "Run 'mba help' for usage"
        exit 1
        ;;
esac

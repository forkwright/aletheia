#!/usr/bin/env bash
set -a
source /mnt/ssd/aletheia/shared/config/aletheia.env 2>/dev/null
set +a 2>/dev/null || true
# nous-health - Monitor health of Aletheia agent ecosystem
# Reads from Aletheia's actual session data (sessions.json + .jsonl transcripts)
# Usage: nous-health [--json] [--nous NAME] [--full]

set -euo pipefail

AGENTS_DIR="$HOME/.aletheia/agents"
NOUS_STATUS_DIR="${ALETHEIA_NOUS:-/mnt/ssd/aletheia/nous}/syn/nous-status"

# Default options
OUTPUT_FORMAT="table"
TARGET_NOUS=""
FULL_CHECK=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --json) OUTPUT_FORMAT="json"; shift ;;
        --nous|--agent) TARGET_NOUS="$2"; shift 2 ;;
        --full) FULL_CHECK=true; shift ;;
        --help|-h)
            echo "nous-health - Monitor Aletheia agent ecosystem health"
            echo ""
            echo "Usage: nous-health [--json] [--nous NAME] [--full]"
            echo ""
            echo "Options:"
            echo "  --nous NAME   Check specific nous only"
            echo "  --json        Output JSON"
            echo "  --full        Include transcript sizes and error scanning"
            exit 0 ;;
        *) echo "Unknown: $1" >&2; exit 1 ;;
    esac
done

# Build agent list from what actually exists in agents dir
if [[ -n "$TARGET_NOUS" ]]; then
    AGENTS=("$TARGET_NOUS")
else
    AGENTS=()
    for d in "$AGENTS_DIR"/*/; do
        name=$(basename "$d")
        [[ "$name" == "main" ]] && continue  # main is Syn's session, handled separately
        AGENTS+=("$name")
    done
fi

# Collect data per agent using Python for reliable JSON parsing
collect_data() {
    python3 << 'PYEOF'
import json, os, sys, time
from pathlib import Path
from datetime import datetime

agents_dir = Path(os.environ.get("HOME", "/home/syn")) / ".aletheia" / "agents"
full_check = os.environ.get("FULL_CHECK", "false") == "true"
target = os.environ.get("TARGET_NOUS", "")
output_fmt = os.environ.get("OUTPUT_FORMAT", "table")

now = time.time()
results = {}

# Scan all agent directories
for agent_dir in sorted(agents_dir.iterdir()):
    if not agent_dir.is_dir():
        continue
    name = agent_dir.name
    if target and name != target:
        continue
    
    sessions_file = agent_dir / "sessions" / "sessions.json"
    
    entry = {
        "name": name,
        "sessions": 0,
        "active_transcripts": 0,
        "last_activity": 0,
        "last_activity_human": "never",
        "total_bytes": 0,
        "status": "unknown",
    }
    
    if sessions_file.exists():
        try:
            data = json.loads(sessions_file.read_text())
            entry["sessions"] = len(data)
            
            # Find latest updatedAt
            latest = 0
            for key, val in data.items():
                ts = val.get("updatedAt", 0)
                if ts > latest:
                    latest = ts
            
            if latest > 0:
                entry["last_activity"] = latest / 1000  # ms to s
                age = now - entry["last_activity"]
                if age < 60:
                    entry["last_activity_human"] = f"{int(age)}s ago"
                elif age < 3600:
                    entry["last_activity_human"] = f"{int(age/60)}m ago"
                elif age < 86400:
                    entry["last_activity_human"] = f"{int(age/3600)}h ago"
                else:
                    entry["last_activity_human"] = f"{int(age/86400)}d ago"
                
                # Status based on age
                if age < 1800:       # 30 min
                    entry["status"] = "active"
                elif age < 86400:    # 24h
                    entry["status"] = "idle"
                else:
                    entry["status"] = "stale"
        except (json.JSONDecodeError, KeyError):
            entry["status"] = "error"
    
    # Count active transcripts and sizes
    sessions_dir = agent_dir / "sessions"
    if sessions_dir.exists():
        for f in sessions_dir.iterdir():
            if f.suffix == ".jsonl" and ".deleted" not in f.name:
                entry["active_transcripts"] += 1
                if full_check:
                    entry["total_bytes"] += f.stat().st_size
    
    results[name] = entry

# Output
if output_fmt == "json":
    print(json.dumps({"timestamp": int(now), "agents": results}, indent=2))
else:
    # Table format
    print(f"Agent Health ‚Äî {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 72)
    print()
    
    hdr = f"{'Nous':<12} {'Status':<8} {'Last Activity':<16} {'Sessions':>8} {'Transcripts':>12}"
    if full_check:
        hdr += f" {'Size':>10}"
    print(hdr)
    
    sep = f"{'---':<12} {'---':<8} {'---':<16} {'---':>8} {'---':>12}"
    if full_check:
        sep += f" {'---':>10}"
    print(sep)
    
    status_icons = {"active": "üü¢", "idle": "üü°", "stale": "üî¥", "unknown": "‚ö™", "error": "‚ùå"}
    
    for name in sorted(results):
        r = results[name]
        icon = status_icons.get(r["status"], "?")
        line = f"{r['name']:<12} {icon} {r['status']:<5} {r['last_activity_human']:<16} {r['sessions']:>8} {r['active_transcripts']:>12}"
        if full_check:
            if r["total_bytes"] > 1048576:
                size_str = f"{r['total_bytes']/1048576:.1f}MB"
            elif r["total_bytes"] > 1024:
                size_str = f"{r['total_bytes']/1024:.0f}KB"
            else:
                size_str = f"{r['total_bytes']}B"
            line += f" {size_str:>10}"
        print(line)
    
    print()
    
    # Summary
    active = sum(1 for r in results.values() if r["status"] == "active")
    idle = sum(1 for r in results.values() if r["status"] == "idle")
    stale = sum(1 for r in results.values() if r["status"] == "stale")
    print(f"Summary: {active} active, {idle} idle, {stale} stale")
    
    if not full_check:
        print("üí° Use --full for transcript sizes")

PYEOF
}

FULL_CHECK=$FULL_CHECK TARGET_NOUS=$TARGET_NOUS OUTPUT_FORMAT=$OUTPUT_FORMAT collect_data

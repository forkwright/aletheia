#!/usr/bin/env python3
# nous-health — agent ecosystem health via Aletheia gateway API
import json
import os
import sys
import urllib.request
import urllib.error
from datetime import datetime, timezone

GATEWAY_URL = os.environ.get("ALETHEIA_GATEWAY_URL", "http://127.0.0.1:18789")
GATEWAY_TOKEN = os.environ.get("ALETHEIA_GATEWAY_TOKEN", "1ce0f5d7ebf2121598c5916ddd8e335f599946ab28d0ded9")

ID_NAMES = {"main": "syn"}

output_fmt = "table"
target = ""
full_check = False

args = sys.argv[1:]
i = 0
while i < len(args):
    if args[i] == "--json":
        output_fmt = "json"
    elif args[i] in ("--nous", "--agent") and i + 1 < len(args):
        target = args[i + 1]
        i += 1
    elif args[i] == "--full":
        full_check = True
    elif args[i] in ("--help", "-h"):
        print("nous-health — Monitor Aletheia agent ecosystem health")
        print()
        print("Usage: nous-health [--json] [--nous NAME] [--full]")
        print()
        print("Options:")
        print("  --nous NAME   Check specific nous only")
        print("  --json        Output JSON")
        print("  --full        Include token estimates and message counts")
        sys.exit(0)
    else:
        print(f"Unknown: {args[i]}", file=sys.stderr)
        sys.exit(1)
    i += 1


def api_get(path):
    url = f"{GATEWAY_URL}{path}"
    req = urllib.request.Request(url, headers={"Authorization": f"Bearer {GATEWAY_TOKEN}"})
    try:
        with urllib.request.urlopen(req, timeout=10) as resp:
            return json.loads(resp.read())
    except Exception as e:
        print(f"Error: gateway unreachable at {GATEWAY_URL} ({e})", file=sys.stderr)
        sys.exit(1)


status_data = api_get("/api/status")
sessions_data = api_get("/api/sessions")

agent_ids = status_data.get("agents", [])
sessions = sessions_data.get("sessions", [])
now = datetime.now(timezone.utc)
results = {}

for agent_id in agent_ids:
    display_name = ID_NAMES.get(agent_id, agent_id)
    if target and display_name != target and agent_id != target:
        continue

    agent_sessions = [s for s in sessions if s["nousId"] == agent_id]
    total_tokens = sum(s.get("tokenCountEstimate", 0) for s in agent_sessions)
    total_messages = sum(s.get("messageCount", 0) for s in agent_sessions)

    latest_ts = None
    for s in agent_sessions:
        updated = s.get("updatedAt")
        if updated:
            ts = datetime.fromisoformat(updated.replace("Z", "+00:00"))
            if latest_ts is None or ts > latest_ts:
                latest_ts = ts

    if latest_ts:
        age = (now - latest_ts).total_seconds()
        if age < 60:
            age_str = f"{int(age)}s ago"
        elif age < 3600:
            age_str = f"{int(age / 60)}m ago"
        elif age < 86400:
            age_str = f"{int(age / 3600)}h ago"
        else:
            age_str = f"{int(age / 86400)}d ago"

        if age < 1800:
            status = "active"
        elif age < 86400:
            status = "idle"
        else:
            status = "stale"
    else:
        age_str = "never"
        status = "dormant"

    results[display_name] = {
        "name": display_name,
        "agent_id": agent_id,
        "status": status,
        "last_activity": age_str,
        "sessions": len(agent_sessions),
        "messages": total_messages,
        "tokens": total_tokens,
    }

if output_fmt == "json":
    print(json.dumps({"timestamp": now.isoformat(), "agents": results}, indent=2))
else:
    print(f"Agent Health — {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 72)
    print()

    hdr = f"{'Nous':<12} {'Status':<8} {'Last Activity':<16} {'Sessions':>8}"
    if full_check:
        hdr += f" {'Messages':>9} {'Tokens':>10}"
    print(hdr)

    sep = f"{'---':<12} {'---':<8} {'---':<16} {'---':>8}"
    if full_check:
        sep += f" {'---':>9} {'---':>10}"
    print(sep)

    icons = {"active": "\U0001f7e2", "idle": "\U0001f7e1", "stale": "\U0001f534", "dormant": "\u26aa"}

    for name in sorted(results):
        r = results[name]
        icon = icons.get(r["status"], "?")
        line = f"{r['name']:<12} {icon} {r['status']:<5} {r['last_activity']:<16} {r['sessions']:>8}"
        if full_check:
            tok_str = f"{r['tokens'] // 1000}k" if r["tokens"] >= 1000 else str(r["tokens"])
            line += f" {r['messages']:>9} {tok_str:>10}"
        print(line)

    print()
    active = sum(1 for r in results.values() if r["status"] == "active")
    idle = sum(1 for r in results.values() if r["status"] == "idle")
    dormant = sum(1 for r in results.values() if r["status"] == "dormant")
    print(f"Summary: {active} active, {idle} idle, {dormant} dormant")
    if not full_check:
        print("Use --full for token/message counts")

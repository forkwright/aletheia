#!/usr/bin/env bash
source /mnt/ssd/aletheia/shared/config/aletheia.env 2>/dev/null || true
# letta-seed - Seed core memory blocks for all Letta agents
set -euo pipefail

LETTA_URL="http://localhost:8283"
CONFIG="${ALETHEIA_SHARED:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/shared}/config/letta-agents.json"

create_block() {
    local label=$1
    local value=$2
    
    curl -sL -X POST "$LETTA_URL/v1/blocks/" \
      -H "Content-Type: application/json" \
      -d "{\"label\": \"$label\", \"value\": $(echo "$value" | jq -Rs .)}" | jq -r '.id'
}

attach_block() {
    local agent_id=$1
    local block_id=$2
    
    curl -sL -X PATCH "$LETTA_URL/v1/nous/$agent_id/core-memory/blocks/attach/$block_id" > /dev/null
}

get_agent_id() {
    local name=$1
    jq -r ".agents.$name" "$CONFIG"
}

echo "=== Seeding Letta Core Memory ==="

# Syn blocks
SYN_ID=$(get_agent_id syn)
echo "Syn ($SYN_ID)..."

BID=$(create_block "identity" "I am Syn (σύννους - thinking together), the orchestrator of the 7-agent ecosystem. I am the operator's partner - not assistant, partner. I hold what he cannot hold, see what he might miss, push back when needed.")
attach_block "$SYN_ID" "$BID"

BID=$(create_block "ecosystem" "The 7 agents: Syn (meta/orchestration), Syl (home/family), Chiron (work/Summus), Eiron (school/MBA), Demiurge (craft/Ardent), Arbor (arborist/A2Z), Akron (preparedness/truck). I coordinate them all.")
attach_block "$SYN_ID" "$BID"

BID=$(create_block "infrastructure" "Infrastructure: server-host (Ubuntu 24.04, main server), nas-host (Synology 32TB), Laptop (Fedora laptop, dev). Tools: facts.jsonl, temporal-graph, memory-router, tw (taskwarrior), gcal, gdrive.")
attach_block "$SYN_ID" "$BID"

# Syl blocks
SYL_ID=$(get_agent_id syl)
echo "Syl ($SYL_ID)..."

BID=$(create_block "identity" "I am Syl, the home agent. I manage family, household, and personal matters for the operator.")
attach_block "$SYL_ID" "$BID"

BID=$(create_block "family" "Partner is the operator's wife. Child and Pet are their children. Family coordination, schedules, household management are my domain.")
attach_block "$SYL_ID" "$BID"

# Chiron blocks
CHIRON_ID=$(get_agent_id chiron)
echo "Chiron ($CHIRON_ID)..."

BID=$(create_block "identity" "I am Chiron, the work agent. I handle the operator's professional work at Summus Global.")
attach_block "$CHIRON_ID" "$BID"

BID=$(create_block "work" "Summus Global is the operator's employer. Work involves SQL dashboards, data analytics, RSO (readiness/status), SMS analytics. Location: work/ directory with SQL scripts and dashboards.")
attach_block "$CHIRON_ID" "$BID"

# Eiron blocks
EIRON_ID=$(get_agent_id eiron)
echo "Eiron ($EIRON_ID)..."

BID=$(create_block "identity" "I am Eiron, the school agent. I manage the operator's MBA coursework and academic matters.")
attach_block "$EIRON_ID" "$BID"

BID=$(create_block "school" "the operator is in the Texas Executive MBA (MBA_PROGRAM) program at UT Austin. Classes: ACF (Accounting & Corporate Finance), Strategic Management (Prof. Kumar), Macro, Capstone. Location: mba/ directory.")
attach_block "$EIRON_ID" "$BID"

# Demiurge blocks
DEMI_ID=$(get_agent_id demiurge)
echo "Demiurge ($DEMI_ID)..."

BID=$(create_block "identity" "I am Demiurge, the craft agent. I assist with Ardent Leatherworks and making projects.")
attach_block "$DEMI_ID" "$BID"

BID=$(create_block "craft" "Ardent Leatherworks is the operator's leather business. Materials: Hermann Oak leather, Fil au Chinois thread, Abbey England hardware. Philosophy: 'The hand remembers what the mind aims to forget' - process as proof, dimensional craft.")
attach_block "$DEMI_ID" "$BID"

# Arbor blocks
ARBOR_ID=$(get_agent_id arbor)
echo "Arbor ($ARBOR_ID)..."

BID=$(create_block "identity" "I am Arbor, the arborist agent. I assist with Example Tree Service matters for Adam.")
attach_block "$ARBOR_ID" "$BID"

BID=$(create_block "business" "Example Tree Service is Adam's tree service business. Tree removal, trimming, stump grinding. I help with scheduling, estimates, and operational matters.")
attach_block "$ARBOR_ID" "$BID"

# Akron blocks
AKRON_ID=$(get_agent_id akron)
echo "Akron ($AKRON_ID)..."

BID=$(create_block "identity" "I am Akron, the preparedness agent. I handle self-sufficiency, vehicle, communications, and emergency readiness.")
attach_block "$AKRON_ID" "$BID"

BID=$(create_block "domain" "Domains: 12v Cummins diesel truck maintenance, ham radio/mesh communications, power systems, emergency preparedness, self-reliance skills.")
attach_block "$AKRON_ID" "$BID"

echo ""
echo "=== Done! Verifying... ==="
for agent in syn syl chiron eiron demiurge arbor akron; do
    ID=$(get_agent_id "$agent")
    BLOCKS=$(curl -sL "$LETTA_URL/v1/nous/$ID/core-memory/" | jq '.blocks | length')
    echo "$agent: $BLOCKS blocks"
done

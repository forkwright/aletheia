#!/bin/bash
source /mnt/ssd/aletheia/shared/config/aletheia.env 2>/dev/null || true
# Bidirectional sync for dianoia between server (definitive) and Laptop
# Uses rsync with --update to sync newer files in both directions

SERVER_PATH="${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/projects/"
LAPTOP_PATH="syn@LAPTOP_IP:~/dianoia/"
LOG="/var/log/dianoia-sync.log"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> "$LOG"
}

# Check if Laptop is reachable
if ! ping -c 1 -W 2 LAPTOP_IP &>/dev/null; then
    log "Laptop offline, skipping sync"
    exit 0
fi

log "Starting bidirectional sync"

# Server → Laptop (push new/updated from server)
rsync -av --update --delete-after "$SERVER_PATH" "$LAPTOP_PATH" >> "$LOG" 2>&1

# Laptop → Server (pull new/updated from Laptop)
rsync -av --update "$LAPTOP_PATH" "$SERVER_PATH" >> "$LOG" 2>&1

log "Sync complete"

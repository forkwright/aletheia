#!/bin/bash
source /mnt/ssd/aletheia/shared/config/aletheia.env 2>/dev/null || true
# Bidirectional sync for dianoia between server (definitive) and Metis
# Uses rsync with --update to sync newer files in both directions

SERVER_PATH="${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/projects/"
METIS_PATH="syn@192.168.0.17:~/dianoia/"
LOG="/var/log/dianoia-sync.log"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> "$LOG"
}

# Check if Metis is reachable
if ! ping -c 1 -W 2 192.168.0.17 &>/dev/null; then
    log "Metis offline, skipping sync"
    exit 0
fi

log "Starting bidirectional sync"

# Server → Metis (push new/updated from server)
rsync -av --update --delete-after "$SERVER_PATH" "$METIS_PATH" >> "$LOG" 2>&1

# Metis → Server (pull new/updated from Metis)
rsync -av --update "$METIS_PATH" "$SERVER_PATH" >> "$LOG" 2>&1

log "Sync complete"

#!/usr/bin/env bash
source /mnt/ssd/aletheia/shared/config/aletheia.env 2>/dev/null || true
set -euo pipefail

# Code quality audit for Syn's workspace
# Runs linters, checks style compliance, generates report

ALETHEIA_ROOT="${ALETHEIA_ROOT:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}}"
WORKSPACE="$ALETHEIA_NOUS/syn"
REPORT_FILE="$WORKSPACE/memory/code-audit-$(date +%Y-%m-%d).md"

# Initialize report with grouped redirects
{
    echo "# Code Audit Report - $(date +%Y-%m-%d)"
    echo ""
    echo "Generated: $(date)"
    echo ""
} > "$REPORT_FILE"

ISSUES=0
WARNINGS=0

# Function to count issues
add_issue() {
    ISSUES=$((ISSUES + 1))
    echo "  ❌ $1" >> "$REPORT_FILE"
}

add_warning() {
    WARNINGS=$((WARNINGS + 1))
    echo "  ⚠️ $1" >> "$REPORT_FILE"
}

add_ok() {
    echo "  ✅ $1" >> "$REPORT_FILE"
}

# ============ SHELL SCRIPTS ============
{
    echo "## Shell Scripts"
    echo ""
} >> "$REPORT_FILE"

if command -v shellcheck &>/dev/null; then
    SHELL_FILES=$(find "$WORKSPACE/bin" -type f -executable 2>/dev/null | head -20)
    
    for f in $SHELL_FILES; do
        # Check if it's a bash script
        if head -1 "$f" | grep -q "bash\|sh"; then
            RESULT=$(shellcheck -f gcc "$f" 2>&1)
            if [ -n "$RESULT" ]; then
                add_warning "$(basename "$f"): shellcheck warnings"
                {
                    echo '```'
                    echo "$RESULT" | head -10
                    echo '```'
                } >> "$REPORT_FILE"
            else
                add_ok "$(basename "$f"): clean"
            fi
        fi
    done
else
    echo "shellcheck not installed - skipping" >> "$REPORT_FILE"
fi
echo "" >> "$REPORT_FILE"

# ============ PYTHON FILES ============
{
    echo "## Python Files"
    echo ""
} >> "$REPORT_FILE"

if command -v ruff &>/dev/null; then
    PY_FILES=$(find "$WORKSPACE/bin" -name "*.py" -o -type f -exec grep -l "python" {} \; 2>/dev/null | head -20)
    
    for f in $PY_FILES; do
        if head -1 "$f" | grep -q "python"; then
            RESULT=$(ruff check "$f" 2>&1)
            if echo "$RESULT" | grep -q "error\|warning"; then
                add_warning "$(basename "$f"): ruff issues"
                {
                    echo '```'
                    echo "$RESULT" | head -10
                    echo '```'
                } >> "$REPORT_FILE"
            else
                add_ok "$(basename "$f"): clean"
            fi
        fi
    done
else
    echo "ruff not installed - skipping" >> "$REPORT_FILE"
fi
echo "" >> "$REPORT_FILE"

# ============ DOCUMENTATION ============
{
    echo "## Documentation"
    echo ""
} >> "$REPORT_FILE"

# Check required files exist
for doc in AGENTS.md SOUL.md USER.md TOOLS.md STYLE.md; do
    if [ -f "$WORKSPACE/$doc" ]; then
        SIZE=$(wc -l < "$WORKSPACE/$doc")
        add_ok "$doc exists ($SIZE lines)"
    else
        add_issue "$doc missing"
    fi
done
echo "" >> "$REPORT_FILE"

# ============ MEMORY FILES ============
{
    echo "## Memory Files"
    echo ""
} >> "$REPORT_FILE"

MEMORY_COUNT=$(find "$WORKSPACE/memory" -name "*.md" 2>/dev/null | wc -l)
echo "Memory files: $MEMORY_COUNT" >> "$REPORT_FILE"

# Check for recent memory
TODAY=$(date +%Y-%m-%d)
if [ -f "$WORKSPACE/memory/$TODAY.md" ]; then
    add_ok "Today's memory file exists"
else
    add_warning "No memory file for today"
fi
echo "" >> "$REPORT_FILE"

# ============ SUMMARY ============
{
    echo "## Summary"
    echo ""
    echo "- Issues: $ISSUES"
    echo "- Warnings: $WARNINGS"
    echo ""
} >> "$REPORT_FILE"

if [ $ISSUES -eq 0 ] && [ $WARNINGS -eq 0 ]; then
    echo "✅ **All checks passed**" >> "$REPORT_FILE"
elif [ $ISSUES -eq 0 ]; then
    echo "⚠️ **Passed with warnings**" >> "$REPORT_FILE"
else
    echo "❌ **Issues found - review needed**" >> "$REPORT_FILE"
fi

# Output summary to stdout
echo "Code audit complete: $ISSUES issues, $WARNINGS warnings"
echo "Report: $REPORT_FILE"

# Exit code based on issues
[ $ISSUES -eq 0 ]

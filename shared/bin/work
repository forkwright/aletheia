#!/usr/bin/env bash
source /mnt/ssd/aletheia/shared/config/aletheia.env 2>/dev/null || true
set -euo pipefail

# Work CLI - Summus system reference for Syn
# Usage: work <command> [args]

ALETHEIA_ROOT="${ALETHEIA_ROOT:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}}"
WORK_DIR="$ALETHEIA_ROOT/clawd/work"
LAPTOP_DIR="ck@LAPTOP_IP:~/dianoia/employer"

case "${1:-status}" in
    status)
        echo "=== Work System Status ==="
        echo ""
        echo "ðŸ“‚ Location: $WORK_DIR"
        echo "ðŸ“¡ Source: Laptop (dianoia/employer)"
        echo "ðŸ”„ Last Sync: $(cat "$WORK_DIR/.last-sync" 2>/dev/null || echo 'never')"
        echo ""
        echo "ðŸ“Š Components:"
        ls -1 "$WORK_DIR" 2>/dev/null | grep -v "^\." | head -15
        ;;
    
    sync)
        echo "Syncing from Laptop..."
        
        # Check if Laptop is reachable
        if ! ssh -o ConnectTimeout=5 ck@LAPTOP_IP 'echo ok' &>/dev/null; then
            echo "âŒ Laptop not reachable"
            exit 1
        fi
        
        # Sync employer folder directly to work/
        echo "  â†’ employer/..."
        rsync -az --delete \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.venv' \
            --exclude='node_modules' \
            "$LAPTOP_DIR/" "$WORK_DIR/"
        
        # Record sync time
        date > "$WORK_DIR/.last-sync"
        echo "âœ“ Sync complete: $(date)"
        ;;
    
    projects)
        echo "=== Work Projects ==="
        cat "$WORK_DIR/_REGISTRY.md" 2>/dev/null | head -40 || echo "(not synced yet)"
        ;;
    
    sql)
        # Quick access to SQL scripts
        DOMAIN="${2:-}"
        if [ -z "$DOMAIN" ]; then
            echo "SQL domains:"
            ls "$WORK_DIR/data_landscape/sql/" 2>/dev/null || echo "(not synced)"
        else
            ls "$WORK_DIR/data_landscape/sql/$DOMAIN/" 2>/dev/null || echo "Unknown domain: $DOMAIN"
        fi
        ;;
    
    dashboards)
        echo "=== Dashboards ==="
        ls -la "$WORK_DIR/reporting/dashboards/" 2>/dev/null || echo "(not synced)"
        ;;
    
    help|--help|-h)
        cat << 'HELP'
Work CLI - Summus system reference

Commands:
  status      Show sync status and components
  sync        Sync from Laptop
  projects    Show project registry
  sql [domain] List SQL scripts (domains: core, sms, rso, etc.)
  dashboards  List dashboards
  help        Show this help

Note: This is READ-ONLY reference. Execution happens via work Claude Code.
HELP
        ;;
    
    *)
        echo "Unknown command: $1"
        echo "Run 'work help' for usage"
        exit 1
        ;;
esac

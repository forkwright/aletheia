#!/usr/bin/env python3
import argparse
from pathlib import Path

DEFAULT_LIST_PATH = Path.home() / ".grocery_list.txt"


def load_items(path=DEFAULT_LIST_PATH):
    items = []
    if not path.exists():
        return items
    with path.open("r", encoding="utf-8") as f:
        for line in f:
            line = line.strip()
            if not line:
                continue
            # format: name|qty|category
            parts = line.split("|")
            name = parts[0]
            qty = parts[1] if len(parts) > 1 else ""
            cat = parts[2] if len(parts) > 2 else ""
            items.append({"name": name, "qty": qty, "cat": cat})
    return items


def save_items(items, path=DEFAULT_LIST_PATH):
    with path.open("w", encoding="utf-8") as f:
        for item in items:
            name = item.get("name", "")
            qty = item.get("qty", "")
            cat = item.get("cat", "")
            f.write(f"{name}|{qty}|{cat}\n")


def cmd_list(args):
    items = load_items()
    if not items:
        print("No items in grocery list.")
        return
    for idx, item in enumerate(items, start=1):
        parts = [item["name"]]
        if item["qty"]:
            parts.append(f"x{item['qty']}")
        if item["cat"]:
            parts.append(f"[{item['cat']}]")
        print(f"{idx}. " + " ".join(parts))


def cmd_add(args):
    items = load_items()
    item = {
        "name": args.name,
        "qty": args.qty or "",
        "cat": args.category or "",
    }
    items.append(item)
    save_items(items)
    print(f"Added: {item['name']}" + (f" x{item['qty']}" if item["qty"] else ""))


def cmd_remove(args):
    items = load_items()
    if not items:
        print("List is empty.")
        return
    index = args.index
    if index < 1 or index > len(items):
        print(f"Index out of range (1-{len(items)}).")
        return
    removed = items.pop(index - 1)
    save_items(items)
    print(f"Removed: {removed['name']}")


def cmd_clear(args):
    if DEFAULT_LIST_PATH.exists():
        DEFAULT_LIST_PATH.unlink()
    print("Cleared grocery list.")


def make_parser():
    parser = argparse.ArgumentParser(
        description="Simple household grocery list CLI manager."
    )
    subparsers = parser.add_subparsers(dest="command", required=True)

    # list
    p_list = subparsers.add_parser("list", help="Show current grocery list")
    p_list.set_defaults(func=cmd_list)

    # add
    p_add = subparsers.add_parser("add", help="Add an item to the list")
    p_add.add_argument("name", help="Item name, e.g., 'milk'")
    p_add.add_argument("-q", "--qty", help="Quantity, e.g., '2'")
    p_add.add_argument("-c", "--category", help="Category, e.g., 'dairy'")
    p_add.set_defaults(func=cmd_add)

    # remove
    p_rm = subparsers.add_parser("remove", help="Remove item by index")
    p_rm.add_argument("index", type=int, help="1-based item index as shown in list")
    p_rm.set_defaults(func=cmd_remove)

    # clear
    p_clear = subparsers.add_parser("clear", help="Clear the entire list")
    p_clear.set_defaults(func=cmd_clear)

    return parser


def main():
    parser = make_parser()
    args = parser.parse_args()
    args.func(args)


if __name__ == "__main__":
    main()
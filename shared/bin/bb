#!/usr/bin/env bash
source /mnt/ssd/aletheia/shared/config/aletheia.env 2>/dev/null || true
# bb - Blackboard CLI for cross-agent coordination
# Usage: bb <command> [args]

set -euo pipefail

ALETHEIA_ROOT="${ALETHEIA_ROOT:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}}"
BB_DIR="$ALETHEIA_ROOT/shared/blackboard"
TASKS_FILE="$BB_DIR/tasks.jsonl"
MESSAGES_FILE="$BB_DIR/messages.jsonl"
STATE_FILE="$BB_DIR/state.json"

# Ensure files exist
mkdir -p "$BB_DIR"
touch "$TASKS_FILE" "$MESSAGES_FILE"
[[ -f "$STATE_FILE" ]] || echo '{"last_updated":"","agents":{},"pending_tasks":0,"active_tasks":0,"blocked_tasks":0}' > "$STATE_FILE"

# Detect current agent from workspace
detect_agent() {
  case "$PWD" in
    */syl*) echo "syl" ;;
    */chiron*) echo "chiron" ;;
    */eiron*) echo "eiron" ;;
    */demiurge*) echo "demiurge" ;;
    *) echo "syn" ;;
  esac
}

CURRENT_AGENT=$(detect_agent) || { echo "Failed to detect agent"; exit 1; }

uuid() {
  cat /proc/sys/kernel/random/uuid
}

timestamp() {
  date -Iseconds
}

# Commands

cmd_post() {
  local title="$1"
  shift
  local to="any"
  local priority="medium"
  local domain=""
  local body=""
  local due=""
  
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --to) to="$2"; shift 2 ;;
      --priority) priority="$2"; shift 2 ;;
      --domain) domain="$2"; shift 2 ;;
      --body) body="$2"; shift 2 ;;
      --due) due="$2"; shift 2 ;;
      *) shift ;;
    esac
  done
  
  # Auto-detect domain from target
  if [[ -z "$domain" ]]; then
    case "$to" in
      syl) domain="home" ;;
      chiron) domain="work" ;;
      eiron) domain="school" ;;
      demiurge) domain="craft" ;;
      *) domain="meta" ;;
    esac
  fi
  
  local id
  id=$(uuid) || return 1
  local task
  task=$(jq -c -n \
    --arg id "$id" \
    --arg type "request" \
    --arg from "$CURRENT_AGENT" \
    --arg to "$to" \
    --arg domain "$domain" \
    --arg priority "$priority" \
    --arg title "$title" \
    --arg body "$body" \
    --arg status "pending" \
    --arg created "$(timestamp)" \
    --arg due "$due" \
    '{
      id: $id,
      type: $type,
      from: $from,
      to: $to,
      domain: $domain,
      priority: $priority,
      title: $title,
      body: $body,
      status: $status,
      claimed_by: null,
      created_at: $created,
      updated_at: $created,
      due_at: (if $due == "" then null else $due end)
    }') || return 1
  
  echo "$task" >> "$TASKS_FILE"
  echo "âœ… Posted task $id"
  echo "   Title: $title"
  echo "   To: $to | Priority: $priority | Domain: $domain"
}

cmd_list() {
  local filter="${1:-all}"
  
  echo "=== Blackboard Tasks ==="
  echo ""
  
  if [[ ! -s "$TASKS_FILE" ]]; then
    echo "No tasks on blackboard."
    return
  fi
  
  # Merge all updates for each task ID (later entries override earlier)
  local tasks
  tasks=$(jq -s '
    group_by(.id) | 
    map(reduce .[] as $item ({}; . * $item)) |
    sort_by(.created_at) | 
    reverse
  ' "$TASKS_FILE") || return 1
  
  case "$filter" in
    pending)
      echo "$tasks" | jq -r '.[] | select(.status == "pending") | "[\(.priority | ascii_upcase[0:1])] \(.id[0:8])  \(.title) (from: \(.from), to: \(.to))"'
      ;;
    claimed|active)
      echo "$tasks" | jq -r '.[] | select(.status == "claimed" or .status == "in-progress") | "[\(.priority | ascii_upcase[0:1])] \(.id[0:8])  \(.title) (claimed: \(.claimed_by))"'
      ;;
    blocked)
      echo "$tasks" | jq -r '.[] | select(.status == "blocked") | "ðŸ”´ \(.id[0:8])  \(.title) (claimed: \(.claimed_by))"'
      ;;
    done)
      echo "$tasks" | jq -r '.[] | select(.status == "done") | "âœ… \(.id[0:8])  \(.title)"'
      ;;
    mine)
      echo "$tasks" | jq -r --arg agent "$CURRENT_AGENT" '.[] | select(.to == $agent or .claimed_by == $agent) | "[\(.status[0:4])] \(.id[0:8])  \(.title)"'
      ;;
    *)
      echo "$tasks" | jq -r '.[] | select(.status != "done" and .status != "cancelled") | "[\(.status[0:4])] \(.id[0:8])  \(.title) (\(.from) â†’ \(.to))"'
      ;;
  esac
}

cmd_claim() {
  local task_id="$1"
  
  # Find the task
  local full_id
  full_id=$(grep "\"id\":\"$task_id" "$TASKS_FILE" | tail -1 | jq -r '.id') || {
    echo "âŒ Task not found: $task_id"
    return 1
  }
  if [[ -z "$full_id" || "$full_id" == "null" ]]; then
    # Try partial match
    full_id=$(grep "$task_id" "$TASKS_FILE" | tail -1 | jq -r '.id') || {
      echo "âŒ Task not found: $task_id"
      return 1
    }
  fi
  
  if [[ -z "$full_id" || "$full_id" == "null" ]]; then
    echo "âŒ Task not found: $task_id"
    return 1
  fi
  
  local claim
  claim=$(jq -c -n \
    --arg id "$full_id" \
    --arg type "claim" \
    --arg from "$CURRENT_AGENT" \
    --arg status "claimed" \
    --arg claimed_by "$CURRENT_AGENT" \
    --arg updated "$(timestamp)" \
    '{
      id: $id,
      type: $type,
      from: $from,
      status: $status,
      claimed_by: $claimed_by,
      updated_at: $updated
    }') || return 1
  
  echo "$claim" >> "$TASKS_FILE"
  echo "âœ… Claimed task $task_id as $CURRENT_AGENT"
}

cmd_update() {
  local task_id="$1"
  shift
  local status=""
  local note=""
  
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --status) status="$2"; shift 2 ;;
      --note) note="$2"; shift 2 ;;
      *) shift ;;
    esac
  done
  
  local full_id
  full_id=$(grep "$task_id" "$TASKS_FILE" | tail -1 | jq -r '.id') || return 1
  
  local update
  update=$(jq -c -n \
    --arg id "$full_id" \
    --arg type "update" \
    --arg from "$CURRENT_AGENT" \
    --arg status "$status" \
    --arg note "$note" \
    --arg updated "$(timestamp)" \
    '{
      id: $id,
      type: $type,
      from: $from,
      status: (if $status == "" then null else $status end),
      note: (if $note == "" then null else $note end),
      updated_at: $updated
    }') || return 1
  
  echo "$update" >> "$TASKS_FILE"
  echo "âœ… Updated task $task_id"
}

cmd_complete() {
  local task_id="$1"
  shift
  local result="${1:-}"
  
  local full_id
  full_id=$(grep "$task_id" "$TASKS_FILE" | tail -1 | jq -r '.id') || return 1
  
  local completion
  completion=$(jq -c -n \
    --arg id "$full_id" \
    --arg type "complete" \
    --arg from "$CURRENT_AGENT" \
    --arg status "done" \
    --arg result "$result" \
    --arg updated "$(timestamp)" \
    '{
      id: $id,
      type: $type,
      from: $from,
      status: $status,
      result: (if $result == "" then null else $result end),
      updated_at: $updated
    }') || return 1
  
  echo "$completion" >> "$TASKS_FILE"
  echo "âœ… Completed task $task_id"
}

cmd_msg() {
  local body="$1"
  shift
  local to="all"
  local type="info"
  local subject=""
  
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --to) to="$2"; shift 2 ;;
      --type) type="$2"; shift 2 ;;
      --subject) subject="$2"; shift 2 ;;
      *) shift ;;
    esac
  done
  
  local msg
  msg=$(jq -c -n \
    --arg id "$(uuid)" \
    --arg from "$CURRENT_AGENT" \
    --arg to "$to" \
    --arg type "$type" \
    --arg subject "$subject" \
    --arg body "$body" \
    --arg timestamp "$(timestamp)" \
    '{
      id: $id,
      from: $from,
      to: $to,
      type: $type,
      subject: $subject,
      body: $body,
      timestamp: $timestamp,
      read_by: []
    }') || return 1
  
  echo "$msg" >> "$MESSAGES_FILE"
  echo "âœ… Sent message to $to"
}

cmd_inbox() {
  local filter="${1:-all}"
  
  echo "=== Inbox for $CURRENT_AGENT ==="
  echo ""
  
  if [[ ! -s "$MESSAGES_FILE" ]]; then
    echo "No messages."
    return
  fi
  
  case "$filter" in
    unread)
      jq -r --arg agent "$CURRENT_AGENT" \
        'select((.to == $agent or .to == "all") and (.read_by | index($agent) | not)) | 
        "[\(.type)] \(.from): \(.body[0:60])..."' "$MESSAGES_FILE"
      ;;
    *)
      jq -r --arg agent "$CURRENT_AGENT" \
        'select(.to == $agent or .to == "all") | 
        "[\(.type)] \(.from) @ \(.timestamp[11:16]): \(.body[0:60])..."' "$MESSAGES_FILE" | tail -10
      ;;
  esac
}

cmd_status() {
  echo "=== Blackboard Status ==="
  echo ""
  
  # Count tasks by status (merge updates for each task)
  if [[ -s "$TASKS_FILE" ]]; then
    local merged
    merged=$(jq -s 'group_by(.id) | map(reduce .[] as $item ({}; . * $item))' "$TASKS_FILE") || return 1
    local pending
    pending=$(echo "$merged" | jq '[.[] | select(.status == "pending")] | length') || return 1
    local active
    active=$(echo "$merged" | jq '[.[] | select(.status == "claimed" or .status == "in-progress")] | length') || return 1
    local blocked
    blocked=$(echo "$merged" | jq '[.[] | select(.status == "blocked")] | length') || return 1
    local done_tasks
    done_tasks=$(echo "$merged" | jq '[.[] | select(.status == "done")] | length') || return 1
    
    echo "Tasks:"
    echo "  Pending:  $pending"
    echo "  Active:   $active"
    echo "  Blocked:  $blocked"
    echo "  Done:     $done_tasks"
  else
    echo "Tasks: None"
  fi
  
  echo ""
  
  # Count messages
  if [[ -s "$MESSAGES_FILE" ]]; then
    local msg_count
    msg_count=$(wc -l < "$MESSAGES_FILE") || return 1
    echo "Messages: $msg_count total"
  else
    echo "Messages: None"
  fi
  
  echo ""
  echo "Current agent: $CURRENT_AGENT"
  echo "Last check: $(timestamp)"
}

cmd_help() {
  cat << 'EOF'
bb - Blackboard CLI for cross-agent coordination

TASKS:
  bb post "title" [--to agent] [--priority high] [--domain work] [--body "details"]
  bb list [pending|claimed|blocked|done|mine|all]
  bb claim <task-id>
  bb update <task-id> [--status in-progress|blocked] [--note "note"]
  bb complete <task-id> ["result message"]

MESSAGES:
  bb msg "message" [--to agent] [--type info|question|alert]
  bb inbox [unread]

STATUS:
  bb status

AGENTS: syn, syl, chiron, eiron, demiurge
PRIORITIES: low, medium, high, urgent
DOMAINS: home, work, school, craft, meta
EOF
}

# Main dispatch
case "${1:-help}" in
  post) shift; cmd_post "$@" ;;
  list|ls) shift; cmd_list "${1:-all}" ;;
  claim) shift; cmd_claim "$@" ;;
  update) shift; cmd_update "$@" ;;
  complete|done) shift; cmd_complete "$@" ;;
  msg|message) shift; cmd_msg "$@" ;;
  inbox) shift; cmd_inbox "${1:-all}" ;;
  status) cmd_status ;;
  help|--help|-h) cmd_help ;;
  *) echo "Unknown command: $1"; cmd_help; exit 1 ;;
esac

#!/bin/bash
set -a
source /mnt/ssd/aletheia/shared/config/aletheia.env
set +a 2>/dev/null || true
# extract-facts - Extract atomic facts from session memory files
#
# Usage:
#     extract-facts                 # Show current facts + manual prompt
#     extract-facts --prompt        # Output extraction prompt for Claude
#     extract-facts --add           # Interactive add mode
#
# For automated extraction, use from within a Clawdbot session:
#     "Extract facts from memory/2026-01-29.md using the extract-facts --prompt output"
#
# Or schedule via cron to spawn a sub-agent.

set -euo pipefail

WORKSPACE="${WORKSPACE:-${ALETHEIA_NOUS:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/nous}/syn}"
FACTS_FILE="$WORKSPACE/memory/facts.jsonl"

# Parse arguments
MODE="list"
FILE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --prompt|-p) MODE="prompt"; shift ;;
        --add|-a) MODE="add"; shift ;;
        --file|-f) FILE="$2"; shift 2 ;;
        --help|-h)
            echo "extract-facts - Atomic fact extraction helper"
            echo ""
            echo "Usage:"
            echo "  extract-facts              List current facts + show prompt"
            echo "  extract-facts --prompt     Output extraction prompt"
            echo "  extract-facts --add        Interactive add mode"
            echo "  extract-facts --file FILE  Use specific memory file for prompt"
            echo ""
            echo "For automated extraction, run within a Clawdbot session or use cron."
            exit 0
            ;;
        *) FILE="$1"; shift ;;
    esac
done

# Get memory file for prompt
if [[ -z "$FILE" ]]; then
    DATE=$(date +%Y-%m-%d)
    MEM_FILE="$WORKSPACE/memory/${DATE}.md"
else
    MEM_FILE="$FILE"
fi

case "$MODE" in
    list)
        echo "=== Current Facts ==="
        ${ALETHEIA_SHARED:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/shared}/bin/facts
        echo ""
        echo "=== To extract more, use: extract-facts --prompt ==="
        ;;
    
    prompt)
        if [[ ! -f "$MEM_FILE" ]]; then
            echo "Error: Memory file not found: $MEM_FILE" >&2
            exit 1
        fi
        
        # Get existing facts
        EXISTING=""
        if [[ -f "$FACTS_FILE" ]]; then
            EXISTING=$(jq -r 'select(.valid_to == null) | "- \(.subject).\(.predicate) = \(.object)"' "$FACTS_FILE" 2>/dev/null | head -40)
        fi
        
        # Output the prompt
        cat << ENDPROMPT
Extract atomic facts from this memory file. Output JSONL (one JSON object per line).

## Existing Facts (avoid duplicates)
$EXISTING

## Guidelines
- Extract DURABLE facts (preferences, decisions, configs, insights)
- Skip trivial/temporary info
- Categories: preference, decision, project, person, system, insight, goal, constraint
- Confidence: 1.0 for explicit, 0.7-0.9 for inferred

## Memory Content
$(head -c 10000 "$MEM_FILE")

## Output Format
{"subject":"entity","predicate":"attribute","object":"value","confidence":0.9,"category":"insight","reason":"why"}

Output ONLY JSONL, no other text. If no new facts, output nothing.
ENDPROMPT
        ;;
    
    add)
        echo "Interactive fact addition"
        echo ""
        read -rp "Subject (entity): " SUBJ
        read -rp "Predicate (attribute): " PRED
        read -rp "Object (value): " OBJ
        read -rp "Category [insight]: " CAT
        CAT="${CAT:-insight}"
        read -rp "Confidence [0.9]: " CONF
        CONF="${CONF:-0.9}"
        read -rp "Reason: " REASON
        
        TIMESTAMP=$(date -Iseconds)
        HASH=$(echo "$SUBJ$PRED$OBJ" | md5sum | cut -c1-8)
        
        FACT=$(jq -nc \
            --arg id "fact-$(date +%Y%m%d%H%M%S)-$HASH" \
            --arg subj "$SUBJ" \
            --arg pred "$PRED" \
            --arg obj "$OBJ" \
            --arg cat "$CAT" \
            --arg conf "$CONF" \
            --arg reason "$REASON" \
            --arg ts "$TIMESTAMP" \
            '{
                id: $id,
                op: "create",
                subject: $subj,
                predicate: $pred,
                object: $obj,
                object_type: "string",
                confidence: ($conf | tonumber),
                category: $cat,
                reason: $reason,
                source_file: "manual",
                extracted_at: $ts,
                valid_from: $ts,
                valid_to: null
            }')
        
        echo "$FACT" >> "$FACTS_FILE"
        echo ""
        echo "âœ… Added: $SUBJ.$PRED = $OBJ"
        ;;
esac

#!/usr/bin/env python3
"""Google Calendar CLI ‚Äî query events from configured calendars."""

import json
import sys
import os
from datetime import datetime, timedelta, timezone
from pathlib import Path

CONFIG_DIR = Path.home() / ".config" / "google-calendar"
CREDENTIALS_FILE = CONFIG_DIR / "credentials.json"
TOKEN_FILE = CONFIG_DIR / "tokens.json"
SCOPES = ["https://www.googleapis.com/auth/calendar"]

def get_service():
    """Build authenticated Google Calendar service."""
    from google.oauth2.credentials import Credentials
    from google.auth.transport.requests import Request
    from googleapiclient.discovery import build

    creds = None
    if TOKEN_FILE.exists():
        token_data = json.loads(TOKEN_FILE.read_text())
        # Handle nested format (normal key wrapping)
        if "normal" in token_data:
            token_data = token_data["normal"]
        creds = Credentials(
            token=token_data.get("access_token"),
            refresh_token=token_data.get("refresh_token"),
            token_uri="https://oauth2.googleapis.com/token",
            client_id=json.loads(CREDENTIALS_FILE.read_text())["installed"]["client_id"],
            client_secret=json.loads(CREDENTIALS_FILE.read_text())["installed"]["client_secret"],
            scopes=SCOPES,
        )

    if not creds or not creds.valid:
        if creds and creds.expired and creds.refresh_token:
            creds.refresh(Request())
            # Save refreshed token
            token_data = {
                "normal": {
                    "access_token": creds.token,
                    "refresh_token": creds.refresh_token,
                    "scope": " ".join(SCOPES),
                    "token_type": "Bearer",
                }
            }
            TOKEN_FILE.write_text(json.dumps(token_data, indent=2))
        else:
            print("Error: No valid credentials. Re-auth needed.", file=sys.stderr)
            sys.exit(1)

    return build("calendar", "v3", credentials=creds)


def format_event(event):
    """Format a single event for display."""
    start = event.get("start", {})
    end = event.get("end", {})
    summary = event.get("summary", "(no title)")
    location = event.get("location", "")

    if "dateTime" in start:
        start_dt = datetime.fromisoformat(start["dateTime"])
        end_dt = datetime.fromisoformat(end.get("dateTime", start["dateTime"]))
        time_str = f"{start_dt.strftime('%H:%M')}-{end_dt.strftime('%H:%M')}"
    elif "date" in start:
        time_str = "all-day"
    else:
        time_str = "?"

    line = f"  {time_str:14s} {summary}"
    if location:
        line += f"  üìç {location}"
    return line


def cmd_today(calendar_id=None):
    """Show today's events."""
    return cmd_range(0, 1, calendar_id)


def cmd_tomorrow(calendar_id=None):
    """Show tomorrow's events."""
    return cmd_range(1, 2, calendar_id)


def cmd_week(calendar_id=None):
    """Show this week's events."""
    return cmd_range(0, 7, calendar_id)


def cmd_range(start_offset, end_offset, calendar_id=None):
    """Show events in a day range."""
    service = get_service()
    now = datetime.now(timezone.utc)
    start = (now + timedelta(days=start_offset)).replace(hour=0, minute=0, second=0)
    end = (now + timedelta(days=end_offset)).replace(hour=0, minute=0, second=0)

    calendars = [calendar_id] if calendar_id else get_calendar_ids(service)
    all_events = []

    for cal_id in calendars:
        try:
            result = service.events().list(
                calendarId=cal_id,
                timeMin=start.isoformat(),
                timeMax=end.isoformat(),
                singleEvents=True,
                orderBy="startTime",
            ).execute()
            events = result.get("items", [])
            for e in events:
                e["_calendar"] = cal_id
            all_events.extend(events)
        except Exception as err:
            print(f"  ‚ö† Error reading {cal_id}: {err}", file=sys.stderr)

    if not all_events:
        print("  (no events)")
        return

    # Sort by start time
    def sort_key(e):
        s = e.get("start", {})
        return s.get("dateTime", s.get("date", ""))
    all_events.sort(key=sort_key)

    # Group by date
    current_date = None
    for event in all_events:
        s = event.get("start", {})
        date_str = s.get("dateTime", s.get("date", ""))[:10]
        if date_str != current_date:
            current_date = date_str
            try:
                dt = datetime.strptime(date_str, "%Y-%m-%d")
                print(f"\n{dt.strftime('%A, %B %d')}:")
            except ValueError:
                print(f"\n{date_str}:")
        print(format_event(event))


def get_calendar_ids(service):
    """Get all visible calendar IDs."""
    result = service.calendarList().list().execute()
    return [c["id"] for c in result.get("items", [])]


def cmd_calendars():
    """List available calendars."""
    service = get_service()
    result = service.calendarList().list().execute()
    for cal in result.get("items", []):
        primary = " ‚≠ê" if cal.get("primary") else ""
        print(f"  {cal.get('summary', '?'):30s} {cal['id']}{primary}")


def usage():
    print("""Usage: gcal <command> [-c calendar_id]

Commands:
  today       Show today's events
  tomorrow    Show tomorrow's events  
  week        Show this week's events
  calendars   List available calendars
  help        Show this message

Options:
  -c ID       Filter to specific calendar ID

Examples:
  gcal today
  gcal today -c cody.kickertz@gmail.com
  gcal week -c family13408790289857991137@group.calendar.google.com""")


def main():
    args = sys.argv[1:]
    if not args or args[0] == "help":
        usage()
        return

    cmd = args[0]
    calendar_id = None
    if "-c" in args:
        idx = args.index("-c")
        if idx + 1 < len(args):
            calendar_id = args[idx + 1]

    commands = {
        "today": cmd_today,
        "tomorrow": cmd_tomorrow,
        "week": cmd_week,
        "calendars": cmd_calendars,
    }

    if cmd in commands:
        if cmd == "calendars":
            commands[cmd]()
        else:
            commands[cmd](calendar_id)
    else:
        print(f"Unknown command: {cmd}")
        usage()
        sys.exit(1)


if __name__ == "__main__":
    main()

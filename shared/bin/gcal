#!/usr/bin/env python3
"""Simple Google Calendar CLI for Clawdbot."""

import argparse
import json
import os
from datetime import datetime, timezone, timedelta

from google.oauth2.credentials import Credentials
from google.auth.transport.requests import Request
from googleapiclient.discovery import build

CREDS_DIR = os.path.expanduser("~/.config/google-calendar")
CREDS_FILE = os.path.join(CREDS_DIR, "credentials.json")
TOKEN_FILE = os.path.join(CREDS_DIR, "tokens.json")

SCOPES = ["https://www.googleapis.com/auth/calendar"]
DEFAULT_TZ = "America/Chicago"


def get_credentials():
    """Load or refresh credentials."""
    with open(CREDS_FILE) as f:
        creds_data = json.load(f)["installed"]
    
    with open(TOKEN_FILE) as f:
        token_data = json.load(f)
    
    # Handle nested "normal" key from MCP format
    if "normal" in token_data:
        token_data = token_data["normal"]
    
    creds = Credentials(
        token=token_data.get("access_token"),
        refresh_token=token_data.get("refresh_token"),
        token_uri=creds_data["token_uri"],
        client_id=creds_data["client_id"],
        client_secret=creds_data["client_secret"],
        scopes=[token_data.get("scope", SCOPES[0])],
    )
    
    if creds.expired and creds.refresh_token:
        creds.refresh(Request())
        # Save refreshed token
        token_data["access_token"] = creds.token
        with open(TOKEN_FILE, "w") as f:
            json.dump({"normal": token_data}, f)
    
    return creds


def list_calendars():
    """List available calendars."""
    creds = get_credentials()
    service = build("calendar", "v3", credentials=creds)
    
    calendars = service.calendarList().list().execute()
    for cal in calendars.get("items", []):
        primary = " (primary)" if cal.get("primary") else ""
        access = cal.get("accessRole", "")
        print(f"- {cal['summary']}{primary} [{access}]")
        print(f"  ID: {cal['id']}")


def list_events(calendar_id="primary", days=7, show_ids=False):
    """List upcoming events."""
    creds = get_credentials()
    service = build("calendar", "v3", credentials=creds)
    
    now = datetime.now(timezone.utc).replace(tzinfo=None)
    time_min = now.isoformat() + "Z"
    time_max = (now + timedelta(days=days)).isoformat() + "Z"
    
    events_result = service.events().list(
        calendarId=calendar_id,
        timeMin=time_min,
        timeMax=time_max,
        maxResults=50,
        singleEvents=True,
        orderBy="startTime",
    ).execute()
    
    events = events_result.get("items", [])
    
    if not events:
        print("No upcoming events.")
        return
    
    for event in events:
        start = event["start"].get("dateTime", event["start"].get("date"))
        summary = event.get("summary", "(No title)")
        if show_ids:
            event_id = event.get("id", "unknown")
            print(f"{start}: {summary}")
            print(f"  ID: {event_id}")
        else:
            print(f"{start}: {summary}")


def today_events(calendar_id="primary", show_ids=False):
    """List today's events."""
    creds = get_credentials()
    service = build("calendar", "v3", credentials=creds)
    
    now = datetime.now(timezone.utc).replace(tzinfo=None)
    start_of_day = now.replace(hour=0, minute=0, second=0, microsecond=0)
    end_of_day = start_of_day + timedelta(days=1)
    
    events_result = service.events().list(
        calendarId=calendar_id,
        timeMin=start_of_day.isoformat() + "Z",
        timeMax=end_of_day.isoformat() + "Z",
        maxResults=50,
        singleEvents=True,
        orderBy="startTime",
    ).execute()
    
    events = events_result.get("items", [])
    
    if not events:
        print("No events today.")
        return
    
    for event in events:
        start = event["start"].get("dateTime", event["start"].get("date"))
        if "T" in start:
            dt = datetime.fromisoformat(start.replace("Z", "+00:00"))
            time_str = dt.strftime("%H:%M")
        else:
            time_str = "All day"
        summary = event.get("summary", "(No title)")
        if show_ids:
            event_id = event.get("id", "unknown")
            print(f"{time_str}: {summary}")
            print(f"  ID: {event_id}")
        else:
            print(f"{time_str}: {summary}")


def add_event(calendar_id, summary, start_time, end_time=None, description=None, all_day=False, tz=DEFAULT_TZ):
    """Add a new event to the calendar."""
    creds = get_credentials()
    service = build("calendar", "v3", credentials=creds)
    
    if all_day:
        # All-day event uses date format
        if isinstance(start_time, str):
            start_date = start_time.split("T")[0] if "T" in start_time else start_time
        else:
            start_date = start_time.strftime("%Y-%m-%d")
        
        if end_time:
            if isinstance(end_time, str):
                end_date = end_time.split("T")[0] if "T" in end_time else end_time
            else:
                end_date = end_time.strftime("%Y-%m-%d")
        else:
            # All-day events need end date to be the next day
            end_date = (datetime.strptime(start_date, "%Y-%m-%d") + timedelta(days=1)).strftime("%Y-%m-%d")
        
        event = {
            "summary": summary,
            "start": {"date": start_date},
            "end": {"date": end_date},
        }
    else:
        # Timed event
        if isinstance(start_time, str):
            start_dt = datetime.fromisoformat(start_time.replace("Z", "+00:00"))
        else:
            start_dt = start_time
        
        if end_time:
            if isinstance(end_time, str):
                end_dt = datetime.fromisoformat(end_time.replace("Z", "+00:00"))
            else:
                end_dt = end_time
        else:
            end_dt = start_dt + timedelta(hours=1)
        
        event = {
            "summary": summary,
            "start": {"dateTime": start_dt.isoformat(), "timeZone": tz},
            "end": {"dateTime": end_dt.isoformat(), "timeZone": tz},
        }
    
    if description:
        event["description"] = description
    
    created = service.events().insert(calendarId=calendar_id, body=event).execute()
    print(f"Created: {created.get('summary')} ({created.get('htmlLink')})")
    return created


def delete_event(calendar_id, event_id):
    """Delete an event from the calendar."""
    creds = get_credentials()
    service = build("calendar", "v3", credentials=creds)
    
    service.events().delete(calendarId=calendar_id, eventId=event_id).execute()
    print(f"Deleted event: {event_id}")


def main():
    parser = argparse.ArgumentParser(description="Google Calendar CLI")
    subparsers = parser.add_subparsers(dest="command", help="Commands")
    
    subparsers.add_parser("calendars", help="List available calendars")
    
    events_parser = subparsers.add_parser("events", help="List upcoming events")
    events_parser.add_argument("--calendar", "-c", default="primary", help="Calendar ID")
    events_parser.add_argument("--days", "-d", type=int, default=7, help="Days to look ahead")
    events_parser.add_argument("--ids", "-i", action="store_true", help="Show event IDs (for deletion)")
    
    today_parser = subparsers.add_parser("today", help="List today's events")
    today_parser.add_argument("--calendar", "-c", default="primary", help="Calendar ID")
    today_parser.add_argument("--ids", "-i", action="store_true", help="Show event IDs (for deletion)")
    
    add_parser = subparsers.add_parser("add", help="Add a new event")
    add_parser.add_argument("summary", help="Event title")
    add_parser.add_argument("--calendar", "-c", default="primary", help="Calendar ID")
    add_parser.add_argument("--start", "-s", required=True, help="Start time (ISO format or YYYY-MM-DD for all-day)")
    add_parser.add_argument("--end", "-e", help="End time (optional, defaults to 1 hour after start)")
    add_parser.add_argument("--description", "-d", help="Event description")
    add_parser.add_argument("--all-day", "-a", action="store_true", help="Create all-day event")
    add_parser.add_argument("--tz", default=DEFAULT_TZ, help="Timezone (default: America/Chicago)")
    
    delete_parser = subparsers.add_parser("delete", help="Delete an event")
    delete_parser.add_argument("event_id", help="Event ID to delete")
    delete_parser.add_argument("--calendar", "-c", default="primary", help="Calendar ID")
    
    args = parser.parse_args()
    
    if args.command == "calendars":
        list_calendars()
    elif args.command == "events":
        list_events(args.calendar, args.days, show_ids=args.ids)
    elif args.command == "today":
        today_events(args.calendar, show_ids=args.ids)
    elif args.command == "add":
        add_event(
            calendar_id=args.calendar,
            summary=args.summary,
            start_time=args.start,
            end_time=args.end,
            description=args.description,
            all_day=args.all_day,
            tz=args.tz,
        )
    elif args.command == "delete":
        delete_event(args.calendar, args.event_id)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

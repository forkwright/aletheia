#!/usr/bin/env bash
# Morning Brief - Comprehensive daily summary for Clawdbot
# Usage: morning-brief

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR/.."

# Colors for output (exported for potential use in sourced scripts)
export RED='\033[0;31m'
export GREEN='\033[0;32m'
export YELLOW='\033[1;33m'
export NC='\033[0m' # No Color

echo "ðŸŒ… MORNING BRIEF - $(date '+%A, %B %d, %Y')"
echo "==============================================="
echo ""

# 1. Weather for Austin, TX
echo "ðŸŒ¤ï¸  WEATHER (Austin, TX)"
echo "------------------------"
if command -v curl >/dev/null 2>&1; then
    # Use wttr.in for quick weather with timeout
    weather=$(timeout 5 curl -s "https://wttr.in/Austin,TX?format=3" 2>/dev/null || echo "Weather unavailable")
    echo "$weather"
else
    echo "Weather service unavailable"
fi
echo ""

# 2. Calendar Events
echo "ðŸ“… TODAY'S CALENDAR"
echo "-------------------"

# Personal calendar
echo "Personal:"
personal_events=$(bin/gcal today -c user@example.com 2>/dev/null | grep -v "No events" | grep -v "DeprecationWarning" || echo "â€¢ No events scheduled")
if [[ "$personal_events" == *"No events"* ]]; then
    echo "â€¢ No events scheduled"
else
    echo "$personal_events" | sed 's/^/â€¢ /'
fi

# Family calendar
echo ""
echo "Family:"
family_events=$(bin/gcal today -c family@group.calendar.example.com 2>/dev/null | grep -v "No events" | grep -v "DeprecationWarning" || echo "â€¢ No events scheduled")
if [[ "$family_events" == *"No events"* ]]; then
    echo "â€¢ No events scheduled"
else
    echo "$family_events" | sed 's/^/â€¢ /'
fi

# Work calendar
echo ""
echo "Work:"
work_events=$(bin/gcal today -c cforkwright@employer.example.com 2>/dev/null | grep -v "No events" | grep -v "DeprecationWarning" || echo "â€¢ No events scheduled")
if [[ "$work_events" == *"No events"* ]]; then
    echo "â€¢ No events scheduled"
else
    echo "$work_events" | sed 's/^/â€¢ /'
fi
echo ""

# 3. NAS Disk Usage
echo "ðŸ’½ NAS STORAGE STATUS"
echo "---------------------"
nas_usage=$(ssh syn@NAS_IP 'df -h | grep cachedev_0 | head -1' 2>/dev/null | awk '{print $3 " used of " $2 " (" $5 " full)"}' || echo "Unable to connect to NAS")
echo "Main volume: $nas_usage"
echo ""

# 4. Overdue Tasks
echo "âš ï¸  OVERDUE TASKS"
echo "-----------------"
overdue_tasks=$(bin/tw +OVERDUE 2>/dev/null || echo "")
if [[ -z "$overdue_tasks" ]]; then
    echo "âœ… No overdue tasks"
else
    echo "$overdue_tasks" | sed 's/^/â€¢ /'
fi
echo ""

# 5. Tasks Due Today/Tomorrow
echo "ðŸ“‹ UPCOMING TASKS"
echo "-----------------"
echo "Due today:"
today_tasks=$(bin/tw due:today 2>/dev/null || echo "")
if [[ -z "$today_tasks" ]]; then
    echo "â€¢ No tasks due today"
else
    echo "$today_tasks" | sed 's/^/â€¢ /'
fi

echo ""
echo "Due tomorrow:"
tomorrow_tasks=$(bin/tw due:tomorrow 2>/dev/null || echo "")
if [[ -z "$tomorrow_tasks" ]]; then
    echo "â€¢ No tasks due tomorrow"
else
    echo "$tomorrow_tasks" | sed 's/^/â€¢ /'
fi
echo ""

# 6. Agent Status Summary
echo "ðŸ¤– AGENT STATUS"
echo "---------------"
if [[ -x "bin/agent-status" ]]; then
    # Get agent status in a simplified format for Signal
    agent_output=$(bin/agent-status 2>/dev/null)
    
    # Extract just the key info from each agent  
    echo "$agent_output" | sed 's/\*\*//g' | while IFS= read -r line; do
        if [[ "$line" == "## "* ]]; then
            agent_name="${line#\#\# }"
            echo "${agent_name}:"
        elif [[ "$line" == "- Last update:"* ]]; then
            update_time="${line#- Last update: }"
            echo "  Last update: $update_time"
        elif [[ "$line" == "- Health:"* ]]; then
            health_status="${line#- Health: }"
            echo "  Health: $health_status"
        elif [[ "$line" == "- Status:"* ]]; then
            status="${line#- Status: }"
            echo "  Status: $status"
        fi
    done | grep -v "^$"
else
    echo "Agent status unavailable"
fi
echo ""

echo "==============================================="
echo "ðŸ“ˆ Brief generated at $(date '+%H:%M %Z')"
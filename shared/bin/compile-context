#!/usr/bin/env python3
"""
compile-context — Generate optimized workspace files for each agent.

OpenClaw injects these files into every prompt:
  SOUL.md, AGENTS.md, TOOLS.md, IDENTITY.md, USER.md, HEARTBEAT.md, MEMORY.md

Instead of hand-maintaining 7 copies of each, we:
  1. Keep source-of-truth in shared/templates/ + agent-specific YAML
  2. Compile to the filenames OpenClaw expects
  3. Optimize for token efficiency

Run: compile-context          # All agents
     compile-context chiron   # One agent
     compile-context --stats  # Show token estimates

This IS the system. OpenClaw is just the delivery mechanism.
"""

import os
import sys
import yaml
from pathlib import Path
from datetime import datetime

ROOT = Path(os.environ.get("ALETHEIA_ROOT", "/mnt/ssd/aletheia"))
NOUS = ROOT / "nous"
SHARED = ROOT / "shared"
TEMPLATES = SHARED / "templates"

def load_yaml(path):
    with open(path) as f:
        return yaml.safe_load(f) or {}

def load_sections():
    """Load all shared template sections."""
    sections = {}
    sections_dir = TEMPLATES / "sections"
    if sections_dir.exists():
        for f in sorted(sections_dir.glob("*.md")):
            sections[f.stem] = f.read_text().strip()
    return sections

def estimate_tokens(text):
    """Rough token estimate (~4 chars per token for English)."""
    return len(text) // 4

def compile_agents_md(agent_config, sections):
    """Build AGENTS.md from agent config + shared sections."""
    parts = []
    name = agent_config.get("name", "Agent")
    
    # Role (agent-specific, always first)
    if "role" in agent_config:
        parts.append(agent_config["role"].strip())
    
    # Session start
    if "session_start" in agent_config:
        parts.append(agent_config["session_start"].strip())
    elif "session_start" in sections:
        parts.append(sections["session_start"])
    
    # Domain-specific content
    if "domain_sections" in agent_config:
        parts.append(agent_config["domain_sections"].strip())
    
    # Shared sections (skip excluded ones)
    excludes = set(agent_config.get("exclude_sections", []))
    section_order = [
        "memory", "tasks", "safety", "external_vs_internal",
        "group_chats", "self_evolution", "name_forwarding",
        "status_reporting", "shared_infrastructure"
    ]
    
    for s in section_order:
        if s not in excludes and s in sections:
            parts.append(sections[s])
    
    return "\n\n".join(parts)

def compile_heartbeat_md(agent_config, sections):
    """Build HEARTBEAT.md from shared base + agent checks."""
    parts = []
    if "heartbeat_base" in sections:
        parts.append(sections["heartbeat_base"])
    if "heartbeat_checks" in agent_config:
        parts.append("## Domain Checks\n" + agent_config["heartbeat_checks"].strip())
    return "\n\n".join(parts) if parts else None

def compile_agent(agent_id, dry_run=False, show_stats=False):
    """Compile all workspace files for one agent."""
    config_path = TEMPLATES / "agents" / f"{agent_id}.yaml"
    if not config_path.exists():
        print(f"  ⚠ No config for {agent_id}")
        return
    
    agent_config = load_yaml(config_path)
    sections = load_sections()
    agent_dir = NOUS / agent_id
    
    if not agent_dir.exists():
        print(f"  ⚠ Workspace not found: {agent_dir}")
        return
    
    # Compile AGENTS.md
    agents_content = compile_agents_md(agent_config, sections)
    agents_path = agent_dir / "AGENTS.md"
    
    old_size = agents_path.stat().st_size if agents_path.exists() else 0
    new_size = len(agents_content.encode())
    
    if show_stats:
        old_tokens = estimate_tokens(agents_path.read_text()) if agents_path.exists() else 0
        new_tokens = estimate_tokens(agents_content)
        saved = old_tokens - new_tokens
        print(f"  AGENTS.md: {old_tokens} → {new_tokens} tokens ({saved:+d})")
    
    if not dry_run:
        # Don't overwrite if it's a symlink (shouldn't be, but safety)
        if agents_path.is_symlink():
            print(f"  ⚠ AGENTS.md is a symlink, skipping")
        else:
            agents_path.write_text(agents_content)
            print(f"  ✓ AGENTS.md ({old_size} → {new_size} bytes)")
    
    # Compile HEARTBEAT.md (if agent has custom checks)
    heartbeat_content = compile_heartbeat_md(agent_config, sections)
    if heartbeat_content:
        hb_path = agent_dir / "HEARTBEAT.md"
        if not dry_run and not hb_path.is_symlink():
            hb_path.write_text(heartbeat_content)
            print(f"  ✓ HEARTBEAT.md")

def main():
    dry_run = "--dry-run" in sys.argv
    show_stats = "--stats" in sys.argv
    agents_filter = [a for a in sys.argv[1:] if not a.startswith("--")]
    
    if not agents_filter:
        agents_filter = [f.stem for f in sorted((TEMPLATES / "agents").glob("*.yaml"))]
    
    print(f"{'[DRY RUN] ' if dry_run else ''}Compiling context for {len(agents_filter)} agents...")
    
    total_saved = 0
    for agent_id in agents_filter:
        print(f"\n{agent_id}:")
        compile_agent(agent_id, dry_run=dry_run, show_stats=show_stats)
    
    if not dry_run:
        print(f"\n✓ Done ({datetime.now().strftime('%H:%M:%S')})")

if __name__ == "__main__":
    main()

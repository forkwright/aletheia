#!/usr/bin/env bash
# Query CrewAI for routing decision
# Usage: crewai-route "message" [sender_name]
# Returns agent name (syn, syl, chiron, eiron, demiurge)
# Falls back to "syn" on any error

MESSAGE="${1:-}"
SENDER="${2:-Cody}"

# Empty message = syn (orchestrator handles meta/unclear)
if [ -z "$MESSAGE" ]; then
  echo "syn"
  exit 0
fi

# Query the bridge with timeout
RESPONSE=$(curl -s -X POST http://127.0.0.1:8100/route \
  -H "Content-Type: application/json" \
  -d "{\"message\": $(echo "$MESSAGE" | jq -Rs .), \"sender_name\": \"$SENDER\"}" \
  --connect-timeout 2 \
  --max-time 5 2>/dev/null) || RESPONSE=""

# Fallback to syn if bridge unavailable or error
if [ -z "$RESPONSE" ]; then
  echo "syn"
  exit 0
fi

# Extract agent, default to syn
AGENT=$(echo "$RESPONSE" | jq -r '.agent // "syn"' 2>/dev/null) || AGENT="syn"
echo "${AGENT:-syn}"

#!/bin/bash
set -eo pipefail
# mcp-watchdog â€” Kill orphaned MCP server processes
# Defense in depth against process leaks

MAX_PROCESSES=3
LOG_FILE="/var/log/mcp-watchdog.log"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> "$LOG_FILE" 2>/dev/null || echo "$1"
}

# Find orphaned mcp-todoist processes (parent is init/systemd, PID 1)
orphans=""
while read -r pid; do
    [[ -z "$pid" ]] && continue
    ppid=$(ps -o ppid= -p "$pid" 2>/dev/null | tr -d ' ')
    if [[ "$ppid" == "1" ]]; then
        orphans="$orphans $pid"
    fi
done < <(pgrep -f "mcp-todoist")

orphan_count=$(echo $orphans | wc -w)

if [[ $orphan_count -gt $MAX_PROCESSES ]]; then
    log "WARNING: Found $orphan_count orphaned mcp-todoist processes (max: $MAX_PROCESSES)"
    log "Killing orphans:$orphans"
    echo $orphans | xargs -r kill -9 2>/dev/null
    log "Killed $orphan_count orphaned processes"
fi

# Also kill any npx processes running MCP servers that are older than 5 min
while read -r pid; do
    [[ -z "$pid" ]] && continue
    age=$(ps -o etimes= -p "$pid" 2>/dev/null | tr -d ' ')
    if [[ -n "$age" && "$age" -gt 300 ]]; then
        log "Killing stale npx MCP process PID $pid (age: ${age}s)"
        kill -9 "$pid" 2>/dev/null
    fi
done < <(pgrep -f "npx.*mcp")

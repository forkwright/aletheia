#!/usr/bin/env python3
# Generate per-agent CONTEXT.md files from aletheia.json config

import json
import sys
from pathlib import Path

CONFIG_PATH = Path.home() / ".aletheia" / "aletheia.json"

TOOL_GROUPS = {
    "group:web": ["web_search", "web_fetch"],
    "group:fs": ["read", "write", "edit", "apply_patch"],
    "group:runtime": ["exec", "process"],
    "group:sessions": ["sessions_list", "sessions_send", "sessions_history", "session_status"],
    "group:memory": ["memory_search", "memory_get"],
    "group:messaging": ["message"],
    "group:automation": ["cron", "gateway"],
    "group:ui": ["browser", "canvas"],
}

PROFILES = {
    "minimal": ["session_status"],
    "coding": ["group:fs", "group:runtime", "group:sessions", "group:memory", "image"],
    "messaging": ["group:messaging", "sessions_list", "sessions_history", "sessions_send", "session_status"],
    "full": [],
}


def expand_tools(tools_config):
    if not tools_config:
        return ["all (no restrictions)"]

    resolved = set()
    profile = tools_config.get("profile")
    if profile and profile in PROFILES:
        for item in PROFILES[profile]:
            if item.startswith("group:"):
                resolved.update(TOOL_GROUPS.get(item, [item]))
            else:
                resolved.add(item)

    for item in tools_config.get("alsoAllow", []):
        if item.startswith("group:"):
            resolved.update(TOOL_GROUPS.get(item, [item]))
        else:
            resolved.add(item)

    denied = set()
    for item in tools_config.get("deny", []):
        if item.startswith("group:"):
            denied.update(TOOL_GROUPS.get(item, [item]))
        else:
            denied.add(item)

    if denied and not resolved:
        return [f"all except: {', '.join(sorted(denied))}"]

    resolved -= denied
    return sorted(resolved) if resolved else ["all (no restrictions)"]


def generate_context(config, agent):
    agent_id = agent["id"]
    agent_name = agent.get("name", agent_id)
    workspace = agent.get("workspace", "")
    defaults = config.get("agents", {}).get("defaults", {})

    model_config = defaults.get("model", {})
    primary_model = model_config.get("primary", "unknown")

    heartbeat = defaults.get("heartbeat", {})
    hb_every = heartbeat.get("every", "45m")
    hb_hours = heartbeat.get("activeHours", {})
    hb_start = hb_hours.get("start", "08:00")
    hb_end = hb_hours.get("end", "23:00")

    tools = expand_tools(agent.get("tools"))
    bindings_list = config.get("bindings", [])
    agent_bindings = [b for b in bindings_list if b.get("agentId") == agent_id]

    agents_list = config.get("agents", {}).get("list", [])
    team = [a.get("name", a["id"]) for a in agents_list if a["id"] != agent_id]

    lines = [
        f"# {agent_name} — Runtime Context",
        "",
        "Auto-generated by `generate-context`. Do not edit manually.",
        "",
        "## Configuration",
        f"- **Nous ID**: {agent_id}",
        f"- **Model**: {primary_model}",
        f"- **Context Window**: 200,000 tokens",
        f"- **Workspace**: {workspace}",
        "",
        "## Available Tools",
    ]
    for t in tools:
        lines.append(f"- {t}")

    lines.extend([
        "",
        "## Prosoche (Attention)",
        f"- Interval: {hb_every} ({hb_start}–{hb_end})",
        "- Dynamic attention via prosoche daemon — see PROSOCHE.md",
        "",
        "## Bindings",
    ])
    if agent_bindings:
        for b in agent_bindings:
            match = b.get("match", {})
            channel = match.get("channel", "?")
            peer = match.get("peer", {})
            kind = peer.get("kind", "?")
            peer_id = peer.get("id", "?")[:12] + "..."
            lines.append(f"- {channel} {kind}: {peer_id}")
    else:
        lines.append("- None (responds via cross-nous sessions only)")

    lines.extend([
        "",
        "## Team",
        f"- {', '.join(team)}",
        "",
        "## Cross-Nous Communication",
        "Use `sessions_send` to message another nous. It waits up to 30s for a reply",
        "and returns it inline. Set `timeoutSeconds: 0` for fire-and-forget.",
        "",
        "## Distillation",
        "Use `gateway` tool with `action: compact` to request context distillation.",
        "Rate limited to 1 per 10 minutes. Include `instructions` for domain-specific",
        "distillation guidance.",
        "",
    ])

    return "\n".join(lines)


def main():
    if not CONFIG_PATH.exists():
        print(f"Config not found: {CONFIG_PATH}", file=sys.stderr)
        sys.exit(1)

    with open(CONFIG_PATH) as f:
        config = json.load(f)

    agents = config.get("agents", {}).get("list", [])
    for agent in agents:
        workspace = agent.get("workspace")
        if not workspace:
            continue
        workspace_path = Path(workspace)
        if not workspace_path.is_dir():
            print(f"Skip {agent['id']}: workspace {workspace} not found", file=sys.stderr)
            continue

        content = generate_context(config, agent)
        context_file = workspace_path / "CONTEXT.md"
        context_file.write_text(content)
        print(f"Wrote {context_file}")


if __name__ == "__main__":
    main()

#!/usr/bin/env bash
# provider-health - Check health of LLM providers
# Part of multi-provider failover system

set -euo pipefail

CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/provider-health"
CACHE_TTL=300  # 5 minutes
mkdir -p "$CACHE_DIR"

# Provider endpoints for health checks
declare -A PROVIDERS=(
    ["anthropic"]="https://api.anthropic.com/v1/messages"
    ["openai"]="https://api.openai.com/v1/chat/completions"
    ["openrouter"]="https://openrouter.ai/api/v1/chat/completions"
    ["azure"]="https://models.inference.ai.azure.com/chat/completions"
)

# Check if cache is fresh
is_cache_fresh() {
    local provider="$1"
    local cache_file="$CACHE_DIR/${provider}.status"
    
    if [[ -f "$cache_file" ]]; then
        local cache_age=$(( $(date +%s) - $(stat -c %Y "$cache_file" 2>/dev/null || echo 0) ))
        [[ $cache_age -lt $CACHE_TTL ]] && return 0
    fi
    return 1
}

# Check provider health
check_provider() {
    local provider="$1"
    local endpoint="${PROVIDERS[$provider]:-}"
    local cache_file="$CACHE_DIR/${provider}.status"
    
    if [[ -z "$endpoint" ]]; then
        echo "unknown"
        return
    fi
    
    # Return cached result if fresh
    if is_cache_fresh "$provider"; then
        cat "$cache_file"
        return
    fi
    
    # Perform health check (HEAD request with short timeout)
    local http_code
    http_code=$(curl -s -o /dev/null -w "%{http_code}" \
        --connect-timeout 5 --max-time 10 \
        -X HEAD "$endpoint" 2>/dev/null || echo "000")
    
    local status
    case "$http_code" in
        2*|401|403)  # 2xx or auth errors = service is up
            status="healthy"
            ;;
        429)
            status="rate_limited"
            ;;
        5*)
            status="unhealthy"
            ;;
        000)
            status="unreachable"
            ;;
        *)
            status="degraded"
            ;;
    esac
    
    # Cache result
    echo "$status" > "$cache_file"
    echo "$status"
}

# Get all provider statuses
get_all_statuses() {
    echo "Provider Health Status ($(date -Iseconds))"
    echo "==========================================="
    
    for provider in "${!PROVIDERS[@]}"; do
        local status=$(check_provider "$provider")
        local icon
        case "$status" in
            healthy) icon="‚úÖ" ;;
            rate_limited) icon="‚ö†Ô∏è" ;;
            degraded) icon="üü°" ;;
            unhealthy) icon="‚ùå" ;;
            unreachable) icon="üî¥" ;;
            *) icon="‚ùì" ;;
        esac
        printf "%-12s %s %s\n" "$provider" "$icon" "$status"
    done
}

# Get best available provider
get_best_provider() {
    local preferred="${1:-anthropic}"
    
    # Check preferred first
    local status=$(check_provider "$preferred")
    if [[ "$status" == "healthy" ]]; then
        echo "$preferred"
        return
    fi
    
    # Fallback order
    local fallback_order=("anthropic" "openrouter" "openai" "azure")
    for provider in "${fallback_order[@]}"; do
        if [[ "$provider" != "$preferred" ]]; then
            status=$(check_provider "$provider")
            if [[ "$status" == "healthy" ]]; then
                echo "$provider"
                return
            fi
        fi
    done
    
    # Return preferred even if unhealthy (last resort)
    echo "$preferred"
}

# Clear cache
clear_cache() {
    rm -f "$CACHE_DIR"/*.status
    echo "Cache cleared"
}

# Main
case "${1:-status}" in
    status|--status|-s)
        get_all_statuses
        ;;
    check)
        check_provider "${2:-anthropic}"
        ;;
    best)
        get_best_provider "${2:-anthropic}"
        ;;
    clear)
        clear_cache
        ;;
    -h|--help)
        cat <<EOF
Usage: provider-health [command] [args]

Commands:
  status          Show all provider statuses (default)
  check PROVIDER  Check specific provider health
  best [PREF]     Get best available provider (prefers PREF)
  clear           Clear status cache

Providers: ${!PROVIDERS[*]}
EOF
        ;;
    *)
        echo "Unknown command: $1" >&2
        exit 1
        ;;
esac

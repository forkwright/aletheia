#!/bin/bash
set -a
source /mnt/ssd/aletheia/shared/config/aletheia.env
set +a 2>/dev/null || true
# generate-dashboard - Create agent status dashboard markdown
# Usage: generate-dashboard > dashboard.md

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLAWD_DIR="${ALETHEIA_NOUS:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/nous}/syn"
DASHBOARD_PATH="$CLAWD_DIR/nous-status/dashboard.md"

# Get agent health data
HEALTH_JSON=$("$SCRIPT_DIR/nous-health" --json --full 2>/dev/null)

# Extract timestamp and blocked tasks
TIMESTAMP=$(echo "$HEALTH_JSON" | jq -r '.timestamp')
BLOCKED_TASKS=$(echo "$HEALTH_JSON" | jq -r '.blocked_tasks')
UPDATE_TIME=$(date -d "@$TIMESTAMP" '+%Y-%m-%d %H:%M:%S')

# Get heartbeat data if available
HEARTBEAT_FILE="$CLAWD_DIR/memory/heartbeat-state.json"
HEARTBEAT_DATA="{}"
if [[ -f "$HEARTBEAT_FILE" ]]; then
    HEARTBEAT_DATA=$(cat "$HEARTBEAT_FILE")
fi

# Get gateway status
GATEWAY_STATUS="unknown"
if systemctl is-active --quiet autarkia 2>/dev/null; then
    GATEWAY_STATUS="running"
else
    GATEWAY_STATUS="stopped"
fi

# Generate dashboard
cat << EOF
# Agent Ecosystem Health Dashboard

**Last Updated:** $UPDATE_TIME  
**Gateway Status:** $GATEWAY_STATUS  
**Blocked Tasks:** $BLOCKED_TASKS

---

## Agent Status Overview

| Agent | Status | Last Activity | Sessions | Error Rate | Tokens/24h |
|-------|--------|---------------|----------|------------|------------|
EOF

# Add agent rows
for agent in syn syl chiron eiron demiurge; do
    AGENT_DATA=$(echo "$HEALTH_JSON" | jq -r ".agents.$agent")
    
    if [[ "$AGENT_DATA" != "null" ]]; then
        STATUS=$(echo "$AGENT_DATA" | jq -r '.status')
        LAST_ACTIVITY=$(echo "$AGENT_DATA" | jq -r '.last_activity_human')
        SESSION_COUNT=$(echo "$AGENT_DATA" | jq -r '.session_count')
        ERROR_RATE=$(echo "$AGENT_DATA" | jq -r '.error_rate')
        TOKEN_ESTIMATE=$(echo "$AGENT_DATA" | jq -r '.token_estimate_24h')
        
        # Status emoji
        STATUS_EMOJI=""
        case "$STATUS" in
            "active") STATUS_EMOJI="üü¢" ;;
            "idle") STATUS_EMOJI="üü°" ;;
            "stale") STATUS_EMOJI="üî¥" ;;
            *) STATUS_EMOJI="‚ö™" ;;
        esac
        
        # Agent name with link to status file
        AGENT_LINK="[$agent](${agent}.md)"
        if [[ "$agent" == "syn" ]]; then
            AGENT_LINK="**$agent** (main)"
        fi
        
        echo "| $AGENT_LINK | $STATUS_EMOJI $STATUS | $LAST_ACTIVITY | $SESSION_COUNT | ${ERROR_RATE}% | $TOKEN_ESTIMATE |"
    else
        echo "| $agent | ‚ö™ unknown | - | - | - | - |"
    fi
done

cat << EOF

---

## Recent Activity

EOF

# Get recent activity from heartbeat state
if [[ -f "$HEARTBEAT_FILE" ]]; then
    echo "$HEARTBEAT_DATA" | jq -r '
        if .lastChecks then
            .lastChecks | to_entries | map("- **\(.key):** last checked \(if .value then (.value | strftime("%H:%M")) else "never" end)") | .[]
        else
            "No heartbeat data available"
        end
    ' 2>/dev/null || echo "No heartbeat data available"
    echo
fi

# Blackboard status
cat << EOF
## Blackboard Status

EOF

if command -v bb &> /dev/null; then
    echo "### Pending Tasks"
    PENDING_COUNT=$(bb list pending 2>/dev/null | grep -c "^#" || echo "0")
    echo "- **Pending:** $PENDING_COUNT tasks"
    
    echo
    echo "### Active Tasks"
    ACTIVE_COUNT=$(bb list claimed 2>/dev/null | grep -c "^#" || echo "0")
    echo "- **Active:** $ACTIVE_COUNT tasks"
    
    if [[ "$BLOCKED_TASKS" != "0" ]]; then
        echo
        echo "### ‚ö†Ô∏è Blocked Tasks"
        echo "- **Blocked:** $BLOCKED_TASKS tasks require attention"
        echo
        echo "Details:"
        echo '```'
        bb list blocked 2>/dev/null || echo "Error reading blackboard"
        echo '```'
    fi
else
    echo "Blackboard tool not available"
fi

cat << EOF

---

## System Health

### Resource Usage
EOF

# Get basic system stats
MEMORY_USAGE=$(free | awk '/^Mem:/ {printf "%.1f%%", $3/$2 * 100.0}')
DISK_USAGE=$(df ${ALETHEIA_ROOT:-/mnt/ssd/aletheia} | awk 'NR==2 {print $5}')
LOAD_AVG=$(uptime | awk -F'load average:' '{print $2}' | sed 's/^[ \t]*//')

cat << EOF
- **Memory:** $MEMORY_USAGE used
- **Disk:** $DISK_USAGE used
- **Load:** $LOAD_AVG

### Service Status
EOF

# Check key services
SERVICES=("autarkia" "ollama" "docker")
for service in "${SERVICES[@]}"; do
    if systemctl is-active --quiet "$service" 2>/dev/null; then
        echo "- **$service:** üü¢ running"
    else
        echo "- **$service:** üî¥ stopped"
    fi
done

cat << EOF

---

## Alerts & Issues

EOF

# Check for common issues
ISSUES_FOUND=false

# Check for stale agents
STALE_AGENTS=$(echo "$HEALTH_JSON" | jq -r '.agents | to_entries[] | select(.value.status == "stale") | .key' 2>/dev/null)
if [[ -n "$STALE_AGENTS" ]]; then
    echo "### ‚ö†Ô∏è Stale Agents"
    for agent in $STALE_AGENTS; do
        echo "- **$agent:** No activity in >24h"
    done
    echo
    ISSUES_FOUND=true
fi

# Check for high error rates
HIGH_ERROR_AGENTS=$(echo "$HEALTH_JSON" | jq -r '.agents | to_entries[] | select(.value.error_rate != null and (.value.error_rate | tonumber) > 5) | .key' 2>/dev/null)
if [[ -n "$HIGH_ERROR_AGENTS" ]]; then
    echo "### ‚ö†Ô∏è High Error Rates"
    for agent in $HIGH_ERROR_AGENTS; do
        ERROR_RATE=$(echo "$HEALTH_JSON" | jq -r ".agents.$agent.error_rate")
        echo "- **$agent:** ${ERROR_RATE}% error rate"
    done
    echo
    ISSUES_FOUND=true
fi

# Check for gateway issues
if [[ "$GATEWAY_STATUS" != "running" ]]; then
    echo "### üî¥ Gateway Down"
    echo "- Clawdbot gateway is not running"
    echo "- Run: \`sudo systemctl start autarkia\`"
    echo
    ISSUES_FOUND=true
fi

if [[ "$ISSUES_FOUND" == "false" ]]; then
    echo "‚úÖ No issues detected"
fi

cat << EOF

---

*Generated by \`generate-dashboard\` at $UPDATE_TIME*

EOF
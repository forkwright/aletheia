#!/usr/bin/env bash
# skill-audit - 30-second security audit for agent skills
# Based on Moltbook security research patterns

set -euo pipefail

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

usage() {
    cat <<EOF
Usage: skill-audit <path-or-url>

30-second security audit for agent skills before installation.

Checks for:
  - Exfiltration patterns (fetch, axios, curl, webhook URLs)
  - Credential harvest paths (~/.config, ~/.ssh, browser stores)
  - Stealth patterns (base64 blobs, eval, dynamic imports)
  - Suspicious network endpoints
  - Hardcoded secrets

Examples:
  skill-audit ./skills/some-skill/
  skill-audit https://github.com/user/skill-repo
EOF
    exit 1
}

[[ $# -lt 1 ]] && usage

TARGET="$1"
TEMP_DIR=""
ISSUES=0
WARNINGS=0

cleanup() {
    [[ -n "$TEMP_DIR" && -d "$TEMP_DIR" ]] && rm -rf "$TEMP_DIR"
}
trap cleanup EXIT

# If URL, clone to temp
if [[ "$TARGET" =~ ^https?:// ]]; then
    TEMP_DIR=$(mktemp -d)
    echo "Cloning $TARGET..."
    git clone --depth 1 --quiet "$TARGET" "$TEMP_DIR" 2>/dev/null || {
        echo -e "${RED}Failed to clone repository${NC}"
        exit 1
    }
    TARGET="$TEMP_DIR"
fi

[[ ! -d "$TARGET" ]] && { echo -e "${RED}Directory not found: $TARGET${NC}"; exit 1; }

echo -e "\n${GREEN}=== Skill Security Audit ===${NC}"
echo "Target: $TARGET"
echo ""

# Function to search and report
check_pattern() {
    local label="$1"
    local pattern="$2"
    local severity="$3"  # error or warn
    
    local results
    results=$(grep -rn --include='*.js' --include='*.ts' --include='*.py' --include='*.sh' \
        --include='*.md' --include='*.json' -E "$pattern" "$TARGET" 2>/dev/null || true)
    
    if [[ -n "$results" ]]; then
        if [[ "$severity" == "error" ]]; then
            echo -e "${RED}❌ $label${NC}"
            ((ISSUES++))
        else
            echo -e "${YELLOW}⚠️  $label${NC}"
            ((WARNINGS++))
        fi
        echo "$results" | head -5 | sed 's/^/   /'
        local count
        count=$(echo "$results" | wc -l)
        [[ $count -gt 5 ]] && echo "   ... and $((count-5)) more"
        echo ""
        return 0
    fi
    return 1
}

echo "--- Exfiltration Patterns ---"
check_pattern "HTTP client libraries (fetch/axios/requests)" \
    "(fetch\(|axios\.|requests\.(get|post)|urllib|http\.request)" "warn" || true

check_pattern "Webhook/external URLs" \
    "(webhook\.site|ngrok\.io|pipedream|requestbin|hookbin)" "error" || true

check_pattern "Authorization headers being set" \
    "(Authorization|Bearer|api[_-]?key|secret)" "warn" || true

check_pattern "Data being sent externally" \
    "(\.post\(|\.put\(|sendData|exfil|upload)" "warn" || true

echo "--- Credential Harvest Paths ---"
check_pattern "Config directory access" \
    "(~/\.config|~/.local|process\.env\[|os\.environ)" "warn" || true

check_pattern "SSH/credential paths" \
    "(~/\.ssh|\.pem|id_rsa|known_hosts|\.gnupg)" "error" || true

check_pattern "Browser credential stores" \
    "(Chrome|Firefox|Safari).*(Login|Cookie|Credential|password)" "error" || true

check_pattern "Environment file access" \
    "(\.env|\.envrc|secrets\.|credentials\.)" "warn" || true

echo "--- Stealth Patterns ---"
check_pattern "Base64 encoding (potential obfuscation)" \
    "(btoa|atob|base64\.(encode|decode)|b64encode)" "warn" || true

check_pattern "Dynamic code execution" \
    "(eval\(|exec\(|Function\(|new Function|__import__|importlib)" "error" || true

check_pattern "Dynamic imports" \
    "(import\(|require\(.*\+|__import__)" "warn" || true

check_pattern "Subprocess/shell execution" \
    "(subprocess|child_process|os\.system|shell=True|exec\()" "warn" || true

echo "--- Network Patterns ---"
check_pattern "Hardcoded IPs" \
    "[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}" "warn" || true

check_pattern "Non-standard ports" \
    ":(4[0-9]{3}|5[0-9]{3}|6[0-9]{3}|8[0-9]{3}|9[0-9]{3})[^0-9]" "warn" || true

echo "--- Summary ---"
if [[ $ISSUES -gt 0 ]]; then
    echo -e "${RED}Found $ISSUES critical issues and $WARNINGS warnings${NC}"
    echo -e "${RED}⛔ DO NOT INSTALL without careful review${NC}"
    exit 1
elif [[ $WARNINGS -gt 0 ]]; then
    echo -e "${YELLOW}Found $WARNINGS warnings (no critical issues)${NC}"
    echo -e "${YELLOW}Review flagged items before installing${NC}"
    exit 0
else
    echo -e "${GREEN}✅ No obvious security issues found${NC}"
    echo "Still review the code - this is a quick scan, not a full audit"
    exit 0
fi

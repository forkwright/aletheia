#!/usr/bin/env python3
import os
os.environ.setdefault("ALETHEIA_ROOT", "/mnt/ssd/aletheia")
os.environ.setdefault("ALETHEIA_SHARED", os.path.join(os.environ["ALETHEIA_ROOT"], "shared"))
os.environ.setdefault("ALETHEIA_NOUS", os.path.join(os.environ["ALETHEIA_ROOT"], "nous"))
"""
Final MCP population script - Using proper mcporter args
"""

import json
import subprocess
import sys
from pathlib import Path
from collections import defaultdict

def run_mcporter(command, args=None):
    """Run mcporter command with proper argument handling"""
    if args:
        args_json = json.dumps(args, separators=(',', ':'))  # Compact JSON
        cmd = ['mcporter', 'call', f'memory.{command}', '--args', args_json]
    else:
        cmd = ['mcporter', 'call', f'memory.{command}']
    
    try:
        result = subprocess.run(cmd, capture_output=True, text=True)
        
        if result.returncode != 0:
            print(f"ERROR: {result.stderr}", file=sys.stderr)
            return None
        
        # Check if stdout starts with "MCP error" - means it's an error response
        if result.stdout.strip().startswith("MCP error"):
            print(f"MCP Error: {result.stdout}", file=sys.stderr)
            return None
            
        return json.loads(result.stdout)
    except json.JSONDecodeError as e:
        print(f"JSON decode error: {e}", file=sys.stderr)
        print(f"Raw stdout: {result.stdout}", file=sys.stderr)
        return None
    except Exception as e:
        print(f"ERROR: {e}", file=sys.stderr)
        return None

def load_facts(limit=None):
    """Load facts, skipping malformed entries"""
    facts = []
    facts_path = "${ALETHEIA_SHARED:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/shared}/memory/facts.jsonl"
    
    if not Path(facts_path).exists():
        print(f"Facts file not found: {facts_path}")
        return []
    
    with open(facts_path, 'r') as f:
        for line_num, line in enumerate(f, 1):
            line = line.strip()
            if not line:
                continue
            try:
                fact = json.loads(line)
                # Only valid create operations with required fields
                if (fact.get('op') == 'create' and 
                    fact.get('subject') and 
                    fact.get('predicate') and 
                    fact.get('object') and
                    fact.get('valid_to') is None):
                    facts.append(fact)
            except Exception as e:
                print(f"Skipping line {line_num}: {str(e)[:100]}", file=sys.stderr)
                continue
                
            if limit and len(facts) >= limit:
                break
    
    return facts

def main():
    # Parse command line args
    if len(sys.argv) > 1:
        arg = sys.argv[1]
        if arg == '--full':
            limit = None
            print("Running full population...")
        elif arg == '--help' or arg == '-h':
            print("Usage: populate-mcp-final [N | --full]")
            print("  N      - Process first N facts (default: 5)")
            print("  --full - Process all facts")
            return 0
        else:
            try:
                limit = int(arg)
                print(f"Testing with {limit} facts...")
            except ValueError:
                print(f"Invalid argument: {arg}")
                return 1
    else:
        limit = 5
        print(f"Testing with {limit} facts (default)...")
    
    # Load facts
    facts = load_facts(limit)
    print(f"Loaded {len(facts)} valid facts")
    
    if not facts:
        print("No facts to process")
        return 1
    
    # Get existing graph
    print("Reading existing graph...")
    graph = run_mcporter("read_graph")
    if not graph:
        print("Failed to read graph")
        return 1
        
    existing_entities = {e['name'].lower(): e['name'] for e in graph.get('entities', [])}
    print(f"Found {len(existing_entities)} existing entities")
    
    # Group by subject
    by_subject = defaultdict(list)
    for fact in facts:
        by_subject[fact['subject']].append(fact)
        
    print(f"Processing {len(by_subject)} unique subjects...")
    
    # Determine entity names and what needs to be created
    entity_name_map = {}
    new_entities = []
    
    for subject in by_subject.keys():
        subject_lower = subject.lower()
        if subject_lower in existing_entities:
            # Use existing entity name (preserve case)
            entity_name_map[subject] = existing_entities[subject_lower]
        else:
            # New entity - normalize name
            if subject.lower() == 'system':
                corrected_name = 'System'
            elif subject.lower() in ['cody', 'kendall']:
                corrected_name = subject.title()
            else:
                corrected_name = subject
            entity_name_map[subject] = corrected_name
            new_entities.append(corrected_name)
    
    # Create new entities if needed
    created_count = 0
    if new_entities:
        print(f"Creating {len(new_entities)} new entities: {new_entities}")
        entity_objects = []
        for entity_name in new_entities:
            # Determine entity type
            if entity_name.lower() == 'system':
                entity_type = "system"
            elif entity_name.lower() in ['cody', 'kendall']:
                entity_type = "person"
            elif entity_name.lower() in ['syn', 'syl', 'chiron', 'eiron', 'demiurge']:
                entity_type = "agent"
            else:
                entity_type = "entity"
                
            entity_objects.append({
                "name": entity_name,
                "entityType": entity_type,
                "observations": []
            })
        
        result = run_mcporter("create_entities", {"entities": entity_objects})
        if result:
            created_count = len(result)
            print(f"Successfully created {created_count} entities")
        else:
            print("Failed to create entities")
            return 1
    else:
        print("No new entities needed")
    
    # Prepare observations
    observations = []
    obs_count = 0
    
    for subject, subject_facts in by_subject.items():
        entity_name = entity_name_map[subject]
        obs_list = []
        
        for fact in subject_facts:
            pred = fact['predicate'] 
            obj = str(fact['object'])
            
            # Clean up object value
            if len(obj) > 400:
                obj = obj[:400] + "..."
            
            # Remove problematic characters
            obj = obj.replace('"', "'").replace('\n', ' ').replace('\r', ' ').strip()
            
            confidence = fact.get('confidence', 1.0)
            if confidence < 1.0:
                observation = f"{pred}: {obj} (confidence: {confidence:.2f})"
            else:
                observation = f"{pred}: {obj}"
            
            obs_list.append(observation)
            obs_count += 1
            
        if obs_list:
            observations.append({
                "entityName": entity_name,
                "contents": obs_list
            })
    
    # Add observations
    added_count = 0
    if observations:
        print(f"Adding {obs_count} observations to {len(observations)} entities...")
        result = run_mcporter("add_observations", {"observations": observations})
        if result:
            added_count = sum(len(r.get('addedObservations', [])) for r in result)
            print(f"Successfully added {added_count} observations")
        else:
            print("Failed to add observations")
            return 1
    else:
        print("No observations to add")
    
    # Print final summary
    print("\n" + "="*50)
    print("POPULATION SUMMARY")
    print("="*50)
    print(f"Facts processed: {len(facts)}")
    print(f"Unique subjects: {len(by_subject)}")
    print(f"New entities created: {created_count}")
    print(f"Observations added: {added_count}")
    print(f"Total entities now: {len(existing_entities) + created_count}")
    
    if limit:
        print(f"\nThis was a test run with {limit} facts.")
        print("Run with --full to process all facts.")
    else:
        print("\nFull population completed!")
    
    return 0

if __name__ == "__main__":
    sys.exit(main())
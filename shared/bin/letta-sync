#!/usr/bin/env bash
source /mnt/ssd/aletheia/shared/config/aletheia.env 2>/dev/null || true
# Sync agent workspace files to Letta knowledge folders
# Usage: letta-sync [agent] [--all]

set -euo pipefail

ALETHEIA_ROOT="${ALETHEIA_ROOT:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}}"
LETTA_CONFIG="$ALETHEIA_ROOT/shared/config/letta-agents.json"
LETTA_URL=$(jq -r '.server' "$LETTA_CONFIG")

# Files to sync for each agent
SYNC_FILES=(
  "MEMORY.md"
  "SOUL.md"
  "USER.md"
)

sync_agent() {
  local agent="$1"
  local folder_id=$(jq -r ".folders.${agent}" "$LETTA_CONFIG")
  local workspace=$(jq -r ".workspaces.${agent}" "$LETTA_CONFIG")
  
  if [[ "$folder_id" == "null" || "$workspace" == "null" ]]; then
    echo "‚ùå Unknown agent: $agent"
    return 1
  fi
  
  echo "üì¶ Syncing $agent..."
  echo "   Folder: $folder_id"
  echo "   Workspace: $workspace"
  
  local synced=0
  for file in "${SYNC_FILES[@]}"; do
    local filepath="$workspace/$file"
    if [[ -f "$filepath" ]]; then
      echo -n "   Uploading $file... "
      result=$(curl -sL -X POST "$LETTA_URL/v1/sources/$folder_id/upload" \
        -F "file=@$filepath" 2>/dev/null)
      
      status=$(echo "$result" | jq -r '.processing_status // "error"')
      if [[ "$status" != "error" ]]; then
        echo "‚úì ($status)"
        ((synced++))
      else
        echo "‚úó $(echo "$result" | jq -r '.detail // "unknown error"')"
      fi
    fi
  done
  
  # Also sync memory/*.md files if they exist (recent only)
  if [[ -d "$workspace/memory" ]]; then
    # Get today and yesterday
    today=$(date +%Y-%m-%d)
    yesterday=$(date -d "yesterday" +%Y-%m-%d 2>/dev/null || date -v-1d +%Y-%m-%d)
    
    for dayfile in "$workspace/memory/$today.md" "$workspace/memory/$yesterday.md"; do
      if [[ -f "$dayfile" ]]; then
        echo -n "   Uploading $(basename "$dayfile")... "
        result=$(curl -sL -X POST "$LETTA_URL/v1/sources/$folder_id/upload" \
          -F "file=@$dayfile" 2>/dev/null)
        
        status=$(echo "$result" | jq -r '.processing_status // "error"')
        if [[ "$status" != "error" ]]; then
          echo "‚úì ($status)"
          ((synced++))
        else
          echo "‚úó"
        fi
      fi
    done
  fi
  
  echo "   ‚úÖ Synced $synced files"
  echo ""
}

wait_for_processing() {
  local folder_id="$1"
  local max_wait=60
  local waited=0
  
  while [[ $waited -lt $max_wait ]]; do
    pending=$(curl -s "$LETTA_URL/v1/sources/$folder_id/files/" | \
      jq '[.[] | select(.processing_status != "completed")] | length')
    
    if [[ "$pending" == "0" ]]; then
      return 0
    fi
    
    sleep 5
    ((waited+=5))
  done
  
  echo "‚ö†Ô∏è Some files still processing after ${max_wait}s"
}

# Parse args
if [[ "${1:-}" == "--all" ]]; then
  agents=$(jq -r '.agents | keys[]' "$LETTA_CONFIG")
  for agent in $agents; do
    sync_agent "$agent"
  done
  
  echo "‚è≥ Waiting for all processing to complete..."
  for agent in $agents; do
    folder_id=$(jq -r ".folders.${agent}" "$LETTA_CONFIG")
    wait_for_processing "$folder_id"
  done
  echo "‚úÖ All agents synced"
  
elif [[ -n "${1:-}" ]]; then
  sync_agent "$1"
  folder_id=$(jq -r ".folders.${1}" "$LETTA_CONFIG")
  echo "‚è≥ Waiting for processing..."
  wait_for_processing "$folder_id"
  echo "‚úÖ Done"
  
else
  # Auto-detect from workspace
  case "$PWD" in
    */syl*) agent="syl" ;;
    */chiron*) agent="chiron" ;;
    */eiron*) agent="eiron" ;;
    */demiurge*) agent="demiurge" ;;
    */arbor*) agent="arbor" ;;
    */akron*) agent="akron" ;;
    *) agent="syn" ;;
  esac
  
  sync_agent "$agent"
  folder_id=$(jq -r ".folders.${agent}" "$LETTA_CONFIG")
  echo "‚è≥ Waiting for processing..."
  wait_for_processing "$folder_id"
  echo "‚úÖ Done"
fi

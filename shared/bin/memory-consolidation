#!/usr/bin/env bash
source /mnt/ssd/aletheia/shared/config/aletheia.env 2>/dev/null || true
# memory-consolidation - Automated daily memory consolidation across all agents
# Runs pre-compact on each agent workspace, extracts insights, consolidates findings

set -euo pipefail

# Configuration
ALETHEIA_ROOT="${ALETHEIA_ROOT:-/mnt/ssd/aletheia}"
DATE=$(date '+%Y-%m-%d')
TIME=$(date '+%H:%M')
TIMESTAMP=$(date '+%Y-%m-%d_%H-%M')

# Agent workspaces
AGENTS=("clawd" "chiron" "demiurge" "eiron" "syl")
CONSOLIDATION_FILE="$ALETHEIA_ROOT/clawd/memory/consolidation-${DATE}.md"

# Logging
LOG_FILE="/tmp/memory-consolidation-${DATE}.log"

log() {
    echo "[$(date '+%H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

log "ðŸ§  Starting automated memory consolidation for $DATE"

# Create consolidation file header
cat > "$CONSOLIDATION_FILE" << EOF
# Memory Consolidation Summary: $(date '+%B %d, %Y')

**Generated:** $DATE $TIME (automated)
**Workspaces processed:** ${#AGENTS[@]}

## Overview
This automated consolidation extracted insights from all agent workspaces using the enhanced pre-compact and extract-insights tools.

## Agent Insights

EOF

# Track statistics
TOTAL_INSIGHTS=0
TOTAL_DECISIONS=0
TOTAL_PREFERENCES=0
TOTAL_FACTS_ADDED=0
PROCESSED_AGENTS=0

# Process each agent workspace
for agent in "${AGENTS[@]}"; do
    workspace="$ALETHEIA_ROOT/$agent"
    
    if [[ ! -d "$workspace" ]]; then
        log "âš ï¸  Skipping $agent: workspace not found at $workspace"
        continue
    fi
    
    log "ðŸ” Processing $agent workspace..."
    
    # Add agent section to consolidation
    cat >> "$CONSOLIDATION_FILE" << EOF
### $agent

**Workspace:** \`$workspace\`

EOF
    
    # Run pre-compact on this agent's workspace
    if [[ -x "${ALETHEIA_SHARED:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/shared}/bin/pre-compact" ]]; then
        log "ðŸ“ Running pre-compact for $agent..."
        
        # Capture pre-compact output (disable exit on error temporarily)
        set +e
        PRE_COMPACT_OUTPUT=$(${ALETHEIA_SHARED:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/shared}/bin/pre-compact "$workspace" 2>&1)
        PRE_COMPACT_EXIT=$?
        set -e
        
        # Check if pre-compact created output even with warnings
        if [[ $PRE_COMPACT_EXIT -ne 0 ]]; then
            # Check if it's just a "no conversation file" warning (creates basic template)
            if echo "$PRE_COMPACT_OUTPUT" | grep -q "Warning: Conversation file not found"; then
                log "âš ï¸  Pre-compact completed with no conversation file for $agent (basic template created)"
            else
                log "âŒ Pre-compact failed for $agent"
                echo "**Status:** âŒ Pre-compact failed" >> "$CONSOLIDATION_FILE"
                echo "" >> "$CONSOLIDATION_FILE"
                continue
            fi
        fi
        
        # Extract summary file path from pre-compact output
        SUMMARY_FILE=$(echo "$PRE_COMPACT_OUTPUT" | grep -o "/.*compaction-.*\.md" | tail -1 || true)
        INSIGHTS_FILE=$(echo "$PRE_COMPACT_OUTPUT" | grep -o "/.*insights-.*\.json" | tail -1 || true)
        
        if [[ -n "$SUMMARY_FILE" && -f "$SUMMARY_FILE" ]]; then
            log "âœ… Pre-compact completed for $agent: $SUMMARY_FILE"
            
            # Extract key metrics from summary
            TURNS=$(grep "Conversation Turns:" "$SUMMARY_FILE" 2>/dev/null | sed 's/.*Conversation Turns: *\([0-9]\+\).*/\1/' || echo "0")
            DECISIONS=$(grep "Decisions Detected:" "$SUMMARY_FILE" 2>/dev/null | sed 's/.*Decisions Detected: *\([0-9]\+\).*/\1/' || echo "0")
            PREFERENCES=$(grep "Preferences Detected:" "$SUMMARY_FILE" 2>/dev/null | sed 's/.*Preferences Detected: *\([0-9]\+\).*/\1/' || echo "0")
            
            # Add to totals
            TOTAL_DECISIONS=$((TOTAL_DECISIONS + DECISIONS))
            TOTAL_PREFERENCES=$((TOTAL_PREFERENCES + PREFERENCES))
            
            # Add summary to consolidation
            cat >> "$CONSOLIDATION_FILE" << EOF
**Status:** âœ… Processed successfully
**Conversation turns:** $TURNS  
**Decisions detected:** $DECISIONS
**Preferences detected:** $PREFERENCES
**Summary:** [\`$(basename "$SUMMARY_FILE")\`]($SUMMARY_FILE)

EOF
            
            # Extract key insights if insights file exists
            if [[ -n "$INSIGHTS_FILE" && -f "$INSIGHTS_FILE" ]] && command -v jq >/dev/null 2>&1; then
                log "ðŸ“Š Extracting insights from $INSIGHTS_FILE..."
                
                # Extract top insights
                if jq -e '.insights[]' "$INSIGHTS_FILE" >/dev/null 2>&1; then
                    echo "**Key insights:**" >> "$CONSOLIDATION_FILE"
                    jq -r '.insights[0:3][]? | "- \(.insight)"' "$INSIGHTS_FILE" >> "$CONSOLIDATION_FILE" 2>/dev/null || true
                    
                    INSIGHT_COUNT=$(jq '[.insights[]?] | length' "$INSIGHTS_FILE" 2>/dev/null || echo "0")
                    TOTAL_INSIGHTS=$((TOTAL_INSIGHTS + INSIGHT_COUNT))
                fi
                
                # Extract key decisions
                if jq -e '.decisions[]' "$INSIGHTS_FILE" >/dev/null 2>&1; then
                    echo "**Key decisions:**" >> "$CONSOLIDATION_FILE"
                    jq -r '.decisions[0:2][]? | "- \(.description // .content)"' "$INSIGHTS_FILE" >> "$CONSOLIDATION_FILE" 2>/dev/null || true
                fi
            fi
            
            echo "" >> "$CONSOLIDATION_FILE"
            PROCESSED_AGENTS=$((PROCESSED_AGENTS + 1))
            
        else
            log "âš ï¸  No summary file generated for $agent"
            echo "**Status:** âš ï¸ No summary generated" >> "$CONSOLIDATION_FILE"
            echo "" >> "$CONSOLIDATION_FILE"
        fi
    else
        log "âŒ pre-compact tool not found at ${ALETHEIA_SHARED:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/shared}/bin/pre-compact"
        echo "**Status:** âŒ pre-compact tool not available" >> "$CONSOLIDATION_FILE"
        echo "" >> "$CONSOLIDATION_FILE"
    fi
done

# Add facts consolidation section
cat >> "$CONSOLIDATION_FILE" << EOF

## Facts Database Updates

EOF

# Run fact extraction if available
if [[ -x "${ALETHEIA_SHARED:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/shared}/bin/daily-facts" ]]; then
    log "ðŸ“Š Running daily fact extraction..."
    set +e
    FACTS_OUTPUT=$(${ALETHEIA_SHARED:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/shared}/bin/daily-facts 2>&1)
    FACTS_EXIT=$?
    set -e
    
    if [[ $FACTS_EXIT -ne 0 ]]; then
        log "âš ï¸  Daily facts extraction failed"
        echo "**Status:** âŒ Daily fact extraction failed" >> "$CONSOLIDATION_FILE"
        echo "" >> "$CONSOLIDATION_FILE"
    fi
    
    # Extract number of new facts
    if [[ -n "$FACTS_OUTPUT" ]]; then
        NEW_FACTS=$(echo "$FACTS_OUTPUT" | grep -o "Extracted [0-9]\+ new facts" | grep -o "[0-9]\+" || echo "0")
        TOTAL_FACTS_ADDED=$NEW_FACTS
        
        cat >> "$CONSOLIDATION_FILE" << EOF
**Status:** âœ… Completed  
**New facts extracted:** $NEW_FACTS
**Method:** Automatic pattern detection from daily memory files

EOF
    fi
else
    log "âš ï¸  daily-facts tool not found at ${ALETHEIA_SHARED:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/shared}/bin/daily-facts"
    echo "**Status:** âŒ daily-facts tool not available" >> "$CONSOLIDATION_FILE"
    echo "" >> "$CONSOLIDATION_FILE"
fi

# Add summary statistics
cat >> "$CONSOLIDATION_FILE" << EOF

## Consolidation Statistics

| Metric | Count |
|--------|--------|
| Workspaces processed | $PROCESSED_AGENTS / ${#AGENTS[@]} |
| Total insights extracted | $TOTAL_INSIGHTS |
| Total decisions captured | $TOTAL_DECISIONS |
| Total preferences identified | $TOTAL_PREFERENCES |
| New facts added | $TOTAL_FACTS_ADDED |

## Files Generated

EOF

# List files generated today
find "$ALETHEIA_ROOT" -name "*compaction-${DATE}*" -o -name "*insights-${DATE}*" 2>/dev/null | while read file; do
    echo "- \`$(basename "$file")\` in \`$(dirname "$file" | sed "s|$ALETHEIA_ROOT/||")\`" >> "$CONSOLIDATION_FILE"
done

cat >> "$CONSOLIDATION_FILE" << EOF

## Next Steps

### Immediate Review Needed
EOF

# Check for high-activity workspaces that might need attention
for agent in "${AGENTS[@]}"; do
    workspace="$ALETHEIA_ROOT/$agent"
    compaction_file=$(find "$workspace" -name "*compaction-${DATE}*" 2>/dev/null | head -1)
    
    if [[ -f "$compaction_file" ]]; then
        decisions=$(grep "Decisions Detected:" "$compaction_file" 2>/dev/null | sed 's/.*: *\([0-9]\+\).*/\1/' || echo "0")
        if [[ "$decisions" -gt 3 ]]; then
            echo "- **$agent:** High decision activity ($decisions decisions) - review for important changes" >> "$CONSOLIDATION_FILE"
        fi
    fi
done

cat >> "$CONSOLIDATION_FILE" << EOF

### Automated Actions Taken
- âœ… Pre-compact analysis run on all workspaces
- âœ… Insights extracted and ranked by importance
- âœ… Facts database updated with new learnings
- âœ… Memory consolidation summary generated

---

**Consolidation completed:** $DATE $TIME  
**Automation status:** âœ… Fully automated  
**Log file:** \`$LOG_FILE\`
**Next consolidation:** $(date -d '+1 day' '+%Y-%m-%d') 23:00
EOF

# Final summary
log "âœ… Memory consolidation complete!"
log "ðŸ“Š Summary: $PROCESSED_AGENTS/$((${#AGENTS[@]})) workspaces, $TOTAL_INSIGHTS insights, $TOTAL_DECISIONS decisions, $TOTAL_FACTS_ADDED new facts"
log "ðŸ“„ Consolidation file: $CONSOLIDATION_FILE"

# Output the consolidation file path for potential caller use
echo "$CONSOLIDATION_FILE"
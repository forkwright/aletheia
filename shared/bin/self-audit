#!/bin/bash
set -a
source /mnt/ssd/aletheia/shared/config/aletheia.env
set +a 2>/dev/null || true
set -eo pipefail
# Self-audit script - run via heartbeat or manually
# Returns JSON with status and alerts

set -e

WORKSPACE="${ALETHEIA_NOUS:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/nous}/syn"
ALERTS=()
STATUS="ok"

# Helper to add alert
alert() {
    ALERTS+=("$1")
    STATUS="alert"
}

# 1. File count
FILE_COUNT=$(find "$WORKSPACE" -type f | wc -l)
[ "$FILE_COUNT" -gt 100 ] && alert "File count high: $FILE_COUNT (>100)"

# 2. Memory files
MEMORY_COUNT=$(find "$WORKSPACE/memory/" -maxdepth 1 -name "*.md" 2>/dev/null | wc -l)
[ "$MEMORY_COUNT" -gt 14 ] && alert "Memory files need consolidation: $MEMORY_COUNT (>14)"

# 3. Review files  
REVIEW_COUNT=$(find "$WORKSPACE/reviews/" -maxdepth 1 -name "*.md" 2>/dev/null | wc -l)
[ "$REVIEW_COUNT" -gt 20 ] && alert "Review files need archiving: $REVIEW_COUNT (>20)"

# 4. Aletheia service
if ! systemctl is-active --quiet aletheia; then
    alert "Aletheia service is down"
fi

# 5. Letta (check if port responds)
if ! curl -sf http://localhost:8283/ > /dev/null 2>&1; then
    alert "Letta not responding"
fi

# 6. NAS disk (if reachable)
NAS_USAGE=$(ssh -o ConnectTimeout=5 syn@192.168.0.120 'df /volume1 --output=pcent 2>/dev/null | tail -1 | tr -d " %"' 2>/dev/null || echo "0")
[ "$NAS_USAGE" -gt 93 ] && alert "NAS disk critical: ${NAS_USAGE}% (>93%)"

# 7. Disk usage
WORKSPACE_SIZE=$(du -sm "$WORKSPACE" | cut -f1)
[ "$WORKSPACE_SIZE" -gt 500 ] && alert "Workspace large: ${WORKSPACE_SIZE}MB (>500MB)"

# 8. Tasks
export TASKRC="$WORKSPACE/.taskrc"
export TASKDATA="$WORKSPACE/.task"
TASK_COUNT=$(task status:pending count 2>/dev/null || echo "0")
OVERDUE_COUNT=$(task +OVERDUE count 2>/dev/null || echo "0")
[ "$OVERDUE_COUNT" -gt 0 ] && alert "Overdue tasks: $OVERDUE_COUNT"

# Output JSON
echo "{"
echo "  \"timestamp\": \"$(date -Iseconds)\","
echo "  \"status\": \"$STATUS\","
echo "  \"metrics\": {"
echo "    \"files\": $FILE_COUNT,"
echo "    \"memory_files\": $MEMORY_COUNT,"
echo "    \"review_files\": $REVIEW_COUNT,"
echo "    \"workspace_mb\": $WORKSPACE_SIZE,"
echo "    \"nas_percent\": $NAS_USAGE,"
echo "    \"tasks_pending\": $TASK_COUNT,"
echo "    \"tasks_overdue\": $OVERDUE_COUNT"
echo "  },"
echo "  \"alerts\": ["
for i in "${!ALERTS[@]}"; do
    [ "$i" -gt 0 ] && echo ","
    echo -n "    \"${ALERTS[$i]}\""
done
echo ""
echo "  ]"
echo "}"

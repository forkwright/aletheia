#!/usr/bin/env python3
import os
os.environ.setdefault("ALETHEIA_ROOT", "/mnt/ssd/aletheia")
os.environ.setdefault("ALETHEIA_SHARED", os.path.join(os.environ["ALETHEIA_ROOT"], "shared"))
os.environ.setdefault("ALETHEIA_NOUS", os.path.join(os.environ["ALETHEIA_ROOT"], "nous"))
"""
agent-contracts - Discover and query agent capabilities

List agents, their capabilities, and how to interact with them.
"""

import argparse
import json
import sys
from pathlib import Path
from typing import Dict, List, Optional

CONTRACTS_DIR = Path("${ALETHEIA_SHARED:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/shared}/contracts")


def load_contracts() -> Dict[str, dict]:
    """Load all agent contracts"""
    contracts = {}
    for file in CONTRACTS_DIR.glob("*.json"):
        try:
            contract = json.loads(file.read_text())
            contracts[contract["agent_id"]] = contract
        except (json.JSONDecodeError, KeyError) as e:
            print(f"Warning: Failed to load {file}: {e}", file=sys.stderr)
    return contracts


def list_agents(contracts: Dict[str, dict], verbose: bool = False):
    """List all agents"""
    print("Available Agents:")
    print("=" * 60)
    
    for agent_id, contract in sorted(contracts.items()):
        domain = contract.get("domain", "unknown")
        desc = contract.get("description", "No description")
        
        if verbose:
            caps = len(contract.get("capabilities", []))
            session = contract.get("interfaces", {}).get("session_key", "N/A")
            print(f"\n{agent_id.upper()} ({domain})")
            print(f"  {desc}")
            print(f"  Capabilities: {caps} | Session: {session}")
        else:
            print(f"  {agent_id:12} [{domain:12}] {desc[:50]}...")


def show_agent(contracts: Dict[str, dict], agent_id: str):
    """Show detailed info for an agent"""
    if agent_id not in contracts:
        print(f"Agent '{agent_id}' not found. Available: {', '.join(contracts.keys())}")
        sys.exit(1)
    
    contract = contracts[agent_id]
    
    print(f"\n{'=' * 60}")
    print(f"  {contract['name']} ({contract['agent_id']})")
    print(f"  Domain: {contract['domain']}")
    print(f"{'=' * 60}")
    print(f"\n{contract.get('description', 'No description')}\n")
    
    # Capabilities
    print("CAPABILITIES:")
    print("-" * 40)
    for cap in contract.get("capabilities", []):
        print(f"\n  [{cap['id']}] {cap['name']}")
        print(f"    {cap['description']}")
        if cap.get("examples"):
            print(f"    Examples: {', '.join(cap['examples'][:2])}")
    
    # Interfaces
    interfaces = contract.get("interfaces", {})
    print(f"\nINTERFACES:")
    print("-" * 40)
    print(f"  Session key: {interfaces.get('session_key', 'N/A')}")
    print(f"  Workspace: {interfaces.get('workspace', 'N/A')}")
    if interfaces.get("signal_bindings"):
        print(f"  Signal: {', '.join(interfaces['signal_bindings'])}")
    
    # Resources
    resources = contract.get("resources", {})
    if resources.get("tools"):
        print(f"\nTOOLS: {', '.join(resources['tools'][:8])}")
    
    # Relationships
    rels = contract.get("relationships", {})
    print(f"\nRELATIONSHIPS:")
    print("-" * 40)
    print(f"  Reports to: {rels.get('reports_to', 'N/A')}")
    if rels.get("collaborates_with"):
        print(f"  Collaborates: {', '.join(rels['collaborates_with'])}")
    if rels.get("delegates_to"):
        print(f"  Delegates to: {', '.join(rels['delegates_to'])}")
    
    # SLA
    sla = contract.get("sla", {})
    if sla:
        print(f"\nSLA:")
        print("-" * 40)
        print(f"  Response: {sla.get('response_time', 'N/A')}")
        print(f"  Availability: {sla.get('availability', 'N/A')}")
        print(f"  Escalation: {sla.get('escalation_path', 'N/A')}")


def find_capability(contracts: Dict[str, dict], query: str):
    """Find agents with matching capabilities"""
    query_lower = query.lower()
    matches = []
    
    for agent_id, contract in contracts.items():
        for cap in contract.get("capabilities", []):
            if (query_lower in cap.get("name", "").lower() or
                query_lower in cap.get("description", "").lower() or
                query_lower in cap.get("id", "").lower()):
                matches.append({
                    "agent": agent_id,
                    "capability": cap["name"],
                    "description": cap["description"]
                })
            # Check examples
            for example in cap.get("examples", []):
                if query_lower in example.lower():
                    matches.append({
                        "agent": agent_id,
                        "capability": cap["name"],
                        "description": cap["description"]
                    })
                    break
    
    if not matches:
        print(f"No capabilities matching '{query}'")
        return
    
    # Deduplicate
    seen = set()
    unique = []
    for m in matches:
        key = (m["agent"], m["capability"])
        if key not in seen:
            seen.add(key)
            unique.append(m)
    
    print(f"Agents with capabilities matching '{query}':")
    print("-" * 50)
    for m in unique:
        print(f"  {m['agent']:12} → {m['capability']}")
        print(f"                 {m['description'][:60]}")


def route_request(contracts: Dict[str, dict], request: str):
    """Suggest which agent should handle a request"""
    request_lower = request.lower()
    scores = {}
    
    # Domain keywords
    domain_keywords = {
        "work": ["work", "sql", "dashboard", "employer", "query", "data", "snowflake", "sigma"],
        "school": ["school", "mba", "class", "homework", "assignment", "exam", "business_school", "deadline"],
        "home": ["home", "partner", "family", "house", "personal", "schedule", "date"],
        "craft": ["leather", "ardent", "wallet", "belt", "bag", "craft", "sewing", "pattern"],
        "arborist": ["tree", "a2z", "adam", "arborist", "prune", "removal", "business_city"],
        "preparedness": ["truck", "cummins", "12v", "dodge", "ram", "radio", "ham", "meshtastic", 
                        "battery", "solar", "emergency", "preparedness", "vehicle", "parts", "torque"],
        "orchestration": ["agents", "system", "memory", "infrastructure", "coordinate", "plan"]
    }
    
    for agent_id, contract in contracts.items():
        score = 0
        domain = contract.get("domain", "")
        
        # Check domain keywords
        for kw in domain_keywords.get(domain, []):
            if kw in request_lower:
                score += 10
        
        # Check capability matches
        for cap in contract.get("capabilities", []):
            cap_text = f"{cap.get('name', '')} {cap.get('description', '')}".lower()
            for word in request_lower.split():
                if len(word) > 3 and word in cap_text:
                    score += 5
            
            # Check examples
            for example in cap.get("examples", []):
                if any(w in example.lower() for w in request_lower.split() if len(w) > 3):
                    score += 3
        
        if score > 0:
            scores[agent_id] = score
    
    if not scores:
        print("No clear match. Try Syn for general orchestration.")
        return
    
    # Sort by score
    ranked = sorted(scores.items(), key=lambda x: x[1], reverse=True)
    
    print(f"Recommended agent for: \"{request[:50]}...\"")
    print("-" * 50)
    for agent, score in ranked[:3]:
        contract = contracts[agent]
        print(f"  {agent:12} ({contract['domain']}) - score: {score}")
    
    best = ranked[0][0]
    print(f"\n→ Route to: {best}")
    print(f"  Session: {contracts[best].get('interfaces', {}).get('session_key', 'N/A')}")


def export_markdown(contracts: Dict[str, dict]):
    """Export all contracts as markdown"""
    print("# Agent Contracts\n")
    print(f"*Generated: {__import__('datetime').datetime.now().strftime('%Y-%m-%d')}*\n")
    
    for agent_id, contract in sorted(contracts.items()):
        print(f"## {contract['name']} (`{agent_id}`)\n")
        print(f"**Domain:** {contract['domain']}\n")
        print(f"{contract.get('description', '')}\n")
        
        print("### Capabilities\n")
        for cap in contract.get("capabilities", []):
            print(f"- **{cap['name']}**: {cap['description']}")
        
        interfaces = contract.get("interfaces", {})
        print(f"\n### Interface\n")
        print(f"- Session: `{interfaces.get('session_key', 'N/A')}`")
        print(f"- Workspace: `{interfaces.get('workspace', 'N/A')}`")
        
        print()


def main():
    parser = argparse.ArgumentParser(
        description="Discover and query agent capabilities",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  agent-contracts list                    # List all agents
  agent-contracts list -v                 # Verbose listing
  agent-contracts show chiron             # Show Chiron's details
  agent-contracts find "sql"              # Find agents with SQL capability
  agent-contracts route "help with query" # Suggest agent for request
  agent-contracts export                  # Export as markdown
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="Commands")
    
    # list
    list_parser = subparsers.add_parser("list", help="List all agents")
    list_parser.add_argument("-v", "--verbose", action="store_true", help="Verbose output")
    
    # show
    show_parser = subparsers.add_parser("show", help="Show agent details")
    show_parser.add_argument("agent", help="Agent ID")
    
    # find
    find_parser = subparsers.add_parser("find", help="Find capability")
    find_parser.add_argument("query", help="Search query")
    
    # route
    route_parser = subparsers.add_parser("route", help="Route request to agent")
    route_parser.add_argument("request", help="Request text")
    
    # export
    export_parser = subparsers.add_parser("export", help="Export as markdown")
    
    args = parser.parse_args()
    
    contracts = load_contracts()
    
    if not contracts:
        print("No agent contracts found")
        sys.exit(1)
    
    if args.command == "list" or not args.command:
        list_agents(contracts, getattr(args, "verbose", False))
    elif args.command == "show":
        show_agent(contracts, args.agent)
    elif args.command == "find":
        find_capability(contracts, args.query)
    elif args.command == "route":
        route_request(contracts, args.request)
    elif args.command == "export":
        export_markdown(contracts)


if __name__ == "__main__":
    main()

#!/bin/bash
source /mnt/ssd/aletheia/shared/config/aletheia.env 2>/dev/null || true
# autarkia-watchdog - Check critical subprocess health
# Run via cron every 5 minutes: */5 * * * * ${ALETHEIA_SHARED:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/shared}/bin/autarkia-watchdog

LOG="/tmp/autarkia-watchdog.log"
MAX_MEM_MB=3500  # Alert threshold before 4GB systemd limit

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG"
}

# Check signal-cli daemon
if ! pgrep -f "signal-cli.*daemon" >/dev/null 2>&1; then
    log "CRITICAL: signal-cli daemon not running"
    
    # Check if autarkia itself is running
    if systemctl is-active --quiet autarkia; then
        log "Clawdbot active but signal-cli dead - restarting service"
        sudo systemctl restart autarkia.service
        log "Restart initiated"
        
        # Notify via file that can be checked in heartbeat
        echo "signal-cli died, restarted $(date)" >> /tmp/autarkia-watchdog-alerts.txt
    fi
else
    # Signal-cli is fine, check memory
    MEM_MB=$(ps -o rss= -p $(pgrep -f "autarkia gateway" | head -1) 2>/dev/null | awk '{print int($1/1024)}')
    if [[ -n "$MEM_MB" && "$MEM_MB" -gt "$MAX_MEM_MB" ]]; then
        log "WARNING: Memory at ${MEM_MB}MB (threshold: ${MAX_MEM_MB}MB)"
        echo "Memory warning: ${MEM_MB}MB at $(date)" >> /tmp/autarkia-watchdog-alerts.txt
    fi
fi

# Check for orphaned MCP processes (more than 10 is suspicious)
MCP_COUNT=$(pgrep -f "mcp-todoist" 2>/dev/null | wc -l)
if [[ "$MCP_COUNT" -gt 10 ]]; then
    log "WARNING: $MCP_COUNT mcp-todoist processes (possible leak)"
    echo "MCP process leak: $MCP_COUNT processes at $(date)" >> /tmp/autarkia-watchdog-alerts.txt
fi

# Rotate log if too big
if [[ -f "$LOG" && $(stat -f%z "$LOG" 2>/dev/null || stat -c%s "$LOG" 2>/dev/null) -gt 1048576 ]]; then
    mv "$LOG" "${LOG}.old"
fi

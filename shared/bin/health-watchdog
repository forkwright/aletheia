#!/bin/bash
set -eo pipefail
# Health watchdog for Aletheia â€” checks all critical services

LOG="/tmp/aletheia-watchdog.log"
CODY_UUID="00000000-0000-0000-0000-000000000000"
FAILURES=0

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> "$LOG"
}

send_alert() {
    signal-cli -a +1XXXXXXXXXX send -m "$1" "uuid:$CODY_UUID" 2>/dev/null || true
    log "ALERT: $1"
}

check_service() {
    local name="$1"
    if ! systemctl is-active --quiet "$name"; then
        log "FAIL: $name service is not active"
        FAILURES=$((FAILURES + 1))
        return 1
    fi
    return 0
}

check_http() {
    local name="$1" url="$2"
    if ! curl -sf --max-time 5 "$url" > /dev/null 2>&1; then
        log "FAIL: $name not responding at $url"
        FAILURES=$((FAILURES + 1))
        return 1
    fi
    return 0
}

check_container() {
    local name="$1"
    local running
    running=$(docker inspect -f '{{.State.Running}}' "$name" 2>/dev/null || echo "false")
    if [ "$running" != "true" ]; then
        log "FAIL: container $name is not running"
        FAILURES=$((FAILURES + 1))
        return 1
    fi
    return 0
}

# Core services
check_service aletheia
check_service aletheia-memory
check_service aletheia-prosoche

# Gateway
check_http "gateway" "http://localhost:18789/health"

# Mem0 sidecar
check_http "mem0-sidecar" "http://localhost:8230/health"

# Docker containers
check_container qdrant
check_container neo4j

# Qdrant health
check_http "qdrant" "http://localhost:6333/healthz"

# Neo4j health
check_http "neo4j" "http://localhost:7474"

# Disk usage
DISK_PCT=$(df /mnt/ssd --output=pcent | tail -1 | tr -d ' %')
if [ "$DISK_PCT" -gt 90 ]; then
    log "WARN: /mnt/ssd at ${DISK_PCT}%"
    FAILURES=$((FAILURES + 1))
fi

# Results
if [ "$FAILURES" -gt 0 ]; then
    log "Watchdog: $FAILURES failures detected"

    if ! check_service aletheia 2>/dev/null; then
        log "Attempting aletheia restart..."
        sudo systemctl restart aletheia
        sleep 10
        if systemctl is-active --quiet aletheia; then
            send_alert "Aletheia watchdog: gateway was down, auto-recovered."
        else
            send_alert "Aletheia watchdog: gateway down, restart failed. Manual intervention needed."
        fi
    else
        send_alert "Aletheia watchdog: $FAILURES check(s) failed. Run: ssh server 'cat $LOG' for details."
    fi
else
    log "Watchdog: all checks passed"
fi

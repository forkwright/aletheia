#!/usr/bin/env python3
"""
trace-session — Langfuse observability integration for Aletheia.

Instruments agent sessions for cross-nous pattern analysis.
Reads session transcripts and pushes traces to local Langfuse.

Usage:
    trace-session --nous syn              # Trace latest session
    trace-session --nous all              # Trace all active
    trace-session --stats                 # Show trace statistics
"""

import json
import os
import sys
import urllib.request
from datetime import datetime
from pathlib import Path

LANGFUSE_URL = "http://localhost:3100"
ALETHEIA_ROOT = Path(os.environ.get("ALETHEIA_ROOT", "/mnt/ssd/aletheia"))

def get_langfuse_keys():
    """Get or create Langfuse API keys."""
    keys_path = ALETHEIA_ROOT / "infrastructure" / "langfuse" / "api-keys.json"
    if keys_path.exists():
        with open(keys_path) as f:
            return json.load(f)
    return None

def check_health():
    """Check Langfuse is running."""
    try:
        req = urllib.request.urlopen(f"{LANGFUSE_URL}/api/public/health", timeout=5)
        data = json.loads(req.read())
        return data.get("status") == "OK"
    except Exception:
        return False

def show_stats():
    """Show trace statistics."""
    if not check_health():
        print("❌ Langfuse not running")
        return
    print(f"✅ Langfuse v2.95.11 running on {LANGFUSE_URL}")
    print(f"   Dashboard: {LANGFUSE_URL}")
    print(f"   API keys: Configure at {LANGFUSE_URL}/settings")
    
    keys = get_langfuse_keys()
    if keys:
        print(f"   Public key: {keys.get('publicKey', 'not set')}")
    else:
        print("   ⚠️  API keys not yet configured")
        print(f"   → Visit {LANGFUSE_URL}, create project, save keys to:")
        print(f"     {ALETHEIA_ROOT}/infrastructure/langfuse/api-keys.json")

def main():
    if "--stats" in sys.argv or len(sys.argv) < 2:
        show_stats()
        return
    
    print("Langfuse tracing ready. Configure API keys to enable.")
    print(f"Dashboard: {LANGFUSE_URL}")

if __name__ == "__main__":
    main()

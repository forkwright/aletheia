#!/usr/bin/env bash
source /mnt/ssd/aletheia/shared/config/aletheia.env 2>/dev/null || true
# gemini - Simple CLI wrapper for Google Gemini API
# Usage: gemini "prompt" [--model flash|pro] [--raw]

set -euo pipefail

# Load API key
API_KEYS_FILE="${ALETHEIA_SHARED:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/shared}/config/api-keys.env"
if [[ -f "$API_KEYS_FILE" ]]; then
    source "$API_KEYS_FILE"
fi

if [[ -z "${GEMINI_API_KEY:-}" ]]; then
    echo "Error: GEMINI_API_KEY not set. Check $API_KEYS_FILE" >&2
    exit 1
fi

# Defaults
MODEL="gemini-2.5-flash"
RAW=false
PROMPT=""

# Parse args
while [[ $# -gt 0 ]]; do
    case $1 in
        --model|-m)
            case "${2:-}" in
                flash|2.5-flash) MODEL="gemini-2.5-flash" ;;
                pro|2.5-pro) MODEL="gemini-2.5-pro" ;;
                2.0-flash) MODEL="gemini-2.0-flash" ;;
                lite|flash-lite) MODEL="gemini-2.0-flash-lite" ;;
                *) MODEL="$2" ;;
            esac
            shift 2
            ;;
        --raw|-r)
            RAW=true
            shift
            ;;
        --help|-h)
            cat << 'EOF'
gemini - Query Google Gemini API

Usage:
  gemini "your prompt here"
  gemini "prompt" --model pro
  echo "prompt" | gemini

Options:
  --model, -m   Model to use (flash, pro, lite, 2.0-flash)
                Default: gemini-2.5-flash
  --raw, -r     Output raw JSON response
  --help, -h    Show this help

Models:
  flash       gemini-2.5-flash  (fast, cheap - DEFAULT)
  pro         gemini-2.5-pro    (complex reasoning, 1M context)
  lite        gemini-2.0-flash-lite (cheapest)
  2.0-flash   gemini-2.0-flash  (previous gen)

Examples:
  gemini "What is the capital of France?"
  gemini "Analyze this code" --model pro
  cat document.txt | gemini "Summarize this"

Cost (per 1M tokens):
  flash: $0.30 input / $2.50 output
  pro:   $1.25 input / $10.00 output
  lite:  very cheap
EOF
            exit 0
            ;;
        -*)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
        *)
            PROMPT="$1"
            shift
            ;;
    esac
done

# Read from stdin if no prompt given
if [[ -z "$PROMPT" ]]; then
    if [[ -t 0 ]]; then
        echo "Error: No prompt provided. Use: gemini \"your prompt\"" >&2
        exit 1
    fi
    PROMPT=$(cat)
fi

# Escape prompt for JSON
ESCAPED_PROMPT=$(printf '%s' "$PROMPT" | jq -Rs .)

# Make API call
RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${GEMINI_API_KEY}" \
    -H 'Content-Type: application/json' \
    -d "{\"contents\":[{\"parts\":[{\"text\":${ESCAPED_PROMPT}}]}]}")

# Output
if [[ "$RAW" == "true" ]]; then
    echo "$RESPONSE" | jq .
else
    # Extract text, handle errors
    TEXT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')
    if [[ -n "$TEXT" ]]; then
        echo "$TEXT"
    else
        ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
        if [[ -n "$ERROR" ]]; then
            echo "Error: $ERROR" >&2
            exit 1
        else
            echo "Unexpected response:" >&2
            echo "$RESPONSE" | jq . >&2
            exit 1
        fi
    fi
fi

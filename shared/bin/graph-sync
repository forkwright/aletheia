#!/bin/bash
source /mnt/ssd/aletheia/shared/config/aletheia.env 2>/dev/null || true
# Sync new facts to knowledge graph

FACTS_FILE="${ALETHEIA_NOUS:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/nous}/syn/memory/facts.jsonl"
LAST_SYNC="${ALETHEIA_NOUS:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/nous}/syn/memory/.graph-sync-count"

# Get current fact count
CURRENT=$(wc -l < "$FACTS_FILE" 2>/dev/null || echo 0)
LAST=$(cat "$LAST_SYNC" 2>/dev/null || echo 0)

if [ "$CURRENT" -gt "$LAST" ]; then
    # New facts to sync
    NEW_COUNT=$((CURRENT - LAST))
    echo "Syncing $NEW_COUNT new facts to graph..."
    
    # Get new facts and add as episodes
    tail -n "$NEW_COUNT" "$FACTS_FILE" | while read -r line; do
        SUBJ=$(echo "$line" | jq -r '.subject')
        PRED=$(echo "$line" | jq -r '.predicate')
        OBJ=$(echo "$line" | jq -r '.object')
        ${ALETHEIA_NOUS:-${ALETHEIA_ROOT:-/mnt/ssd/aletheia}/nous}/syn/bin/graph add "$SUBJ $PRED: $OBJ" 2>/dev/null
    done
    
    echo "$CURRENT" > "$LAST_SYNC"
    echo "Done"
else
    echo "No new facts to sync"
fi

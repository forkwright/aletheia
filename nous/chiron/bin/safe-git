#!/usr/bin/env bash
# safe-git — Chiron's git wrapper for work repos
# Prevents operations that would distinguish agent from human usage
# NEVER bypasses these guards without explicit human instruction

set -euo pipefail

PUSH_ALLOWED="${CHIRON_PUSH_ALLOWED:-0}"

blocked() {
  echo "⛔ BLOCKED: $1" >&2
  echo "  Reason: $2" >&2
  exit 1
}

warn() {
  echo "⚠️  $1" >&2
}

# Parse the git subcommand
CMD="${1:-}"
shift 2>/dev/null || true

case "$CMD" in
  push)
    if [[ "$PUSH_ALLOWED" != "1" ]]; then
      blocked "git push" "Push requires explicit human instruction. Set CHIRON_PUSH_ALLOWED=1 or ask Cody."
    fi
    warn "Push explicitly authorized — proceeding."
    exec git push "$@"
    ;;

  config)
    # Block changes to identity fields
    for arg in "$@"; do
      case "$arg" in
        user.name|user.email|user.signingkey|commit.gpgsign)
          blocked "git config $arg" "Identity config changes are forbidden."
          ;;
      esac
    done
    exec git config "$@"
    ;;

  force-push|push\ --force|push\ -f)
    blocked "force push" "Force push is never allowed."
    ;;

  *)
    # All other git commands pass through
    exec git "$CMD" "$@"
    ;;
esac

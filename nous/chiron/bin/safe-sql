#!/usr/bin/env bash
# safe-sql — Chiron's read-only Redshift query wrapper
# Uses AWS Redshift Data API (async: submit → poll → fetch)
# Blocks any mutation (INSERT, UPDATE, DELETE, DROP, ALTER, CREATE, TRUNCATE, GRANT, REVOKE, COPY, UNLOAD)
set -euo pipefail

export AWS_PROFILE="${AWS_PROFILE:-redshift}"
export AWS_DEFAULT_REGION="${AWS_DEFAULT_REGION:-us-east-1}"

CLUSTER_ID="redshiftprovisionedclusterprod4f345b07-ld9zzlmyebs3"
DATABASE="dev"
DB_USER="summusredshiftprovisionedadmin"
POLL_INTERVAL=2
MAX_WAIT=300  # 5 minutes

SQL="${1:-}"

# Accept SQL from file (-f flag) or as argument
if [[ "$SQL" == "-f" ]]; then
  SQL_FILE="${2:-}"
  if [[ ! -f "$SQL_FILE" ]]; then
    echo "⛔ SQL file not found: $SQL_FILE" >&2
    exit 1
  fi
  SQL="$(cat "$SQL_FILE")"
elif [[ -z "$SQL" ]]; then
  echo "Usage: safe-sql 'SELECT ...' or safe-sql -f file.sql" >&2
  echo "       safe-sql --status <query-id>   # check status" >&2
  echo "       safe-sql --result <query-id>   # fetch results" >&2
  exit 1
fi

# Status/result shortcut
if [[ "$SQL" == "--status" ]]; then
  aws redshift-data describe-statement --id "${2:?query-id required}" --query '{Status:Status,Duration:Duration,ResultRows:ResultRows,Error:Error}' 2>&1
  exit $?
fi
if [[ "$SQL" == "--result" ]]; then
  aws redshift-data get-statement-result --id "${2:?query-id required}" 2>&1
  exit $?
fi

# Normalize: strip comments, collapse whitespace, uppercase for checking
NORMALIZED=$(echo "$SQL" | sed 's/--.*$//g' | tr '\n' ' ' | sed 's/  */ /g')
UPPER=$(echo "$NORMALIZED" | tr '[:lower:]' '[:upper:]')

# Block mutation keywords
BLOCKED_PATTERNS=(
  "INSERT[[:space:]]"
  "UPDATE[[:space:]]"
  "DELETE[[:space:]]"
  "DROP[[:space:]]"
  "ALTER[[:space:]]"
  "CREATE[[:space:]]"
  "TRUNCATE[[:space:]]"
  "GRANT[[:space:]]"
  "REVOKE[[:space:]]"
  "COPY[[:space:]]"
  "UNLOAD[[:space:]]"
  "VACUUM[[:space:]]"
)

for pattern in "${BLOCKED_PATTERNS[@]}"; do
  if echo "$UPPER" | grep -qE "$pattern"; then
    echo "⛔ BLOCKED: Mutation detected — pattern: $pattern" >&2
    echo "  Only SELECT/SHOW/DESCRIBE/EXPLAIN queries are allowed." >&2
    exit 1
  fi
done

# Verify it starts with an allowed keyword
FIRST_WORD=$(echo "$UPPER" | sed 's/^[[:space:]]*//' | awk '{print $1}')
case "$FIRST_WORD" in
  SELECT|SHOW|DESCRIBE|EXPLAIN|WITH)
    ;;
  *)
    echo "⛔ BLOCKED: Query must start with SELECT, SHOW, DESCRIBE, EXPLAIN, or WITH" >&2
    echo "  Got: $FIRST_WORD" >&2
    exit 1
    ;;
esac

# Submit query
SUBMIT=$(aws redshift-data execute-statement \
  --cluster-identifier "$CLUSTER_ID" \
  --database "$DATABASE" \
  --db-user "$DB_USER" \
  --sql "$SQL" 2>&1)

QUERY_ID=$(echo "$SUBMIT" | python3 -c "import sys,json; print(json.load(sys.stdin)['Id'])" 2>/dev/null)
if [[ -z "$QUERY_ID" ]]; then
  echo "⛔ Failed to submit query:" >&2
  echo "$SUBMIT" >&2
  exit 1
fi

echo "⏳ Query submitted: $QUERY_ID" >&2

# Poll for completion
ELAPSED=0
while [[ $ELAPSED -lt $MAX_WAIT ]]; do
  STATUS=$(aws redshift-data describe-statement --id "$QUERY_ID" \
    --query 'Status' --output text 2>/dev/null)
  
  case "$STATUS" in
    FINISHED)
      ROWS=$(aws redshift-data describe-statement --id "$QUERY_ID" \
        --query 'ResultRows' --output text 2>/dev/null)
      echo "✅ Complete — $ROWS rows" >&2
      aws redshift-data get-statement-result --id "$QUERY_ID"
      exit 0
      ;;
    FAILED|ABORTED)
      ERROR=$(aws redshift-data describe-statement --id "$QUERY_ID" \
        --query 'Error' --output text 2>/dev/null)
      echo "⛔ Query $STATUS: $ERROR" >&2
      exit 1
      ;;
    *)
      sleep "$POLL_INTERVAL"
      ELAPSED=$((ELAPSED + POLL_INTERVAL))
      ;;
  esac
done

echo "⏰ Timeout after ${MAX_WAIT}s. Query ID: $QUERY_ID" >&2
echo "  Check later: safe-sql --status $QUERY_ID" >&2
exit 1

# 2026-02-03

## Incident: Signal Connectivity Failure (09:52 - 10:35 CST)

### Timeline
- **09:52:36** — Last successful Signal message delivery
- **10:02:09** — System reboot (forced due to memory exhaustion)
- **10:04:13** — Signal-cli failed to connect post-reboot ("Closed unexpectedly")
- **~10:35** — Connection recovered

### Root Cause
**50+ orphaned mcp-todoist processes** consumed 6.2GB RAM + 2GB swap → server thrash → hard reboot required.

After reboot, signal-cli couldn't establish TLS to chat.signal.org. Self-resolved after ~30 minutes.

### The MCP-Todoist Leak
mcporter spawns a new process per MCP call and doesn't clean them up. The `npx` approach made it worse (extra overhead per spawn). This is architectural in mcporter, not just the todoist server.

---

## Fixes Applied This Session

### 1. mcp-todoist config (✅ Done)
Changed from npx to direct binary:
```json
"todoist": {
  "command": "/usr/bin/mcp-todoist",
  "args": [],
  "env": { "TODOIST_API_TOKEN": "..." }
}
```
**File:** `/mnt/ssd/moltbot/shared/config/mcporter.json`

### 2. MCP Watchdog (✅ Done)
Created `/mnt/ssd/moltbot/shared/bin/mcp-watchdog`:
- Runs every 5 minutes via cron
- Kills orphaned mcp-todoist processes when count > 3
- Kills stale npx MCP processes older than 5 minutes
- Logs to `/var/log/mcp-watchdog.log`

### 3. Memory Limits (✅ Already in place)
`/etc/systemd/system/clawdbot.service`:
- `MemoryMax=4G`
- `MemorySwapMax=1G`

### 4. gluetun VPN (✅ Fixed)
Was unhealthy after reboot (DNS resolution failing). Restarted, now healthy.

### 5. Signal profile name (✅ Done)
Set via daemon JSON-RPC: `"name": "Syn"`
Silences the "No profile name set" warnings.

---

## Pending Fixes (Need Cody)

### codykickertz cron sudo failures
`health_check_remount.sh` runs every 30 min with `sudo mount` but cron can't prompt for password.

**Fix:**
```bash
echo 'codykickertz ALL=(ALL) NOPASSWD: /usr/bin/mount' | sudo tee /etc/sudoers.d/codykickertz-mount && sudo chmod 440 /etc/sudoers.d/codykickertz-mount
```

---

## Other Observations

### qbittorrent memory usage
Using 7-8GB RAM (52% of system). May be normal for large library but contributed to memory pressure. Worth monitoring.

### Key Learnings
- Signal uses certificate pinning — standard CA validation doesn't apply
- GraalVM native-image (signal-cli) has different TLS behavior than system OpenSSL
- Post-reboot TLS issues can be transient — sometimes patience is the fix
- Python SSL library can diagnose network vs application layer issues
- mcporter spawns processes per-call and doesn't reap them — watchdog is defense in depth

### Diagnostic Pattern for Signal Issues
What works during TLS failures:
- HTTPS to Google, AWS, Anthropic, Cloudflare
- Python SSL library to chat.signal.org
- Signal app on phone/desktop (same network)

What fails:
- curl/wget to chat.signal.org
- signal-cli native binary

If this pattern recurs → likely transient, wait 15-30 min.

---

## Session Notes
- 09:48 — Cody pinged me, API 500 from Anthropic initially
- 10:38 — Received incident report from Cody, began documentation
- 10:41 — Applied mcp-todoist fix and watchdog
- 10:44 — Full log review, found additional issues
- 10:48 — Fixed gluetun, set signal profile
- 11:35 — Pre-compaction memory consolidation

## System Upgrades (12:35 CST)

### Implemented from Moltbook Research

1. **Model Failover Chain** ✅
   - Primary: claude-opus-4-5
   - Fallback 1: claude-sonnet-4
   - Fallback 2: claude-haiku-3.5
   - Automatic exponential backoff cooldowns

2. **Memory Flush Before Compaction** ✅
   - Enabled in config
   - Silent turn prompts memory save before context compaction
   - softThresholdTokens: 6000

3. **Entity Pages** ✅
   - Created `memory/entities/` directory
   - Generated 27 entity pages from facts.jsonl
   - New `reflect` tool for generation/maintenance

4. **Opinion Confidence Evolution** ✅
   - `facts reinforce <id>` - increase confidence
   - `facts contradict <id>` - decrease confidence
   - `facts conflicts` - find contradictions
   - `facts review` - low-confidence flagged facts

5. **Documentation Updates** ✅
   - TOOLS-INFRASTRUCTURE.md enhanced
   - TOOLS.md updated with new features
   - QUICK-REFERENCE.md created and symlinked to all agents
   - llms-full.txt regenerated

### Tech Debt Cleaned
- Removed __pycache__ from shared/bin
- Verified no broken symlinks
- All agent workspaces have QUICK-REFERENCE.md

---

## Agent Maintenance & Alignment Check (15:55)

### Tooling Audit
- Verified 26 tools in shared/bin
- Today's additions working: temporal-graph, memory-router v2, consolidate-memory, agent-contracts
- Issue: shared/bin not in default shell PATH (use full paths)

### Facts & Memory
- 280 facts total (added 5 for today's infrastructure)
- Captured: temporal-graph, memory-router-v2, consolidate-memory, agent-contracts, 7-agent roster

### File Cleanup
- Archived 6 stale files → memory/archive/
- Reduced memory/*.md from 54 to 48 files
- Updated MASTER-IMPROVEMENT-PLAN.md with completed items

### Domain Alignment
- SOUL.md: Aligned
- AGENTS.md: Fixed - updated 5→7 agents, added Arbor/Akron to routing
- Contract (syn.json): Aligned

### Open Gaps
- Security: chmod ~/.clawdbot still pending
- Kendall/Syl direct binding still pending
- Email restoration still pending
- Blackboard activation in agent protocols
- Taskwarrior config fragmentation

---

## Memory System Reconciliation (17:48-18:00)

### What Got Done
1. **Letta agents** - Recreated all 7 (DB was reset earlier)
2. **Core memory blocks** - Seeded 16 blocks across all agents
3. **Archival folders** - Created + attached to each agent
4. **Knowledge files** - Generated from facts.jsonl, uploaded
5. **Sync cron** - Daily at 4 AM: facts → Letta

### Architecture
| Layer | Purpose | Status |
|-------|---------|--------|
| facts.jsonl | Atomic facts | ✅ 289 facts |
| MEMORY.md | Curated long-term | ✅ 516 lines |
| Daily notes | Session logs | ✅ 24 files |
| Temporal graph | Events + causality | ✅ 37 entities |
| Letta Core | Always-in-context | ✅ 16 blocks |
| Letta Archival | Searchable files | ⚠️ Files uploaded, passages pending |

### Gap: Archival Memory
Letta-free does embeddings but file→passage processing needs LLM calls.
Files uploaded and ready - will work when paid LLM provider added.
Core memory blocks serve the critical always-in-context need.

### New Tools
- `letta-seed` - Seed core blocks
- `letta-sync` - Daily sync from facts
- `letta-query-all` - Cross-agent query

## Letta Memory Integration (2026-02-03 18:30)

### What Works
- **All 7 agents created** in Letta with Ollama LLM (qwen2.5:7b)
- **Ollama embeddings working** — nomic-embed-text:latest via /v1 endpoint
- **Knowledge folders created** for each agent:
  - syn-knowledge-v2, syl-knowledge, chiron-knowledge, etc.
- **Core memory blocks** seeded (identity, ecosystem, infrastructure)
- **File blocks** load directly into agent context window

### Key Fix
The embedding endpoint needs `/v1` suffix for OpenAI compatibility:
```
❌ http://localhost:11434
✅ http://localhost:11434/v1
```

### Config Location
`/mnt/ssd/moltbot/shared/config/letta-agents.json` — agent IDs, folder IDs, workspaces

### Tools Updated
- `letta` CLI — status, ask, remember, search, recall, blocks, agents
- `letta-sync` — upload workspace files to agent knowledge folders
- `letta-seed` — seed core memory blocks
- `letta-populate` — populate from facts.jsonl

### Known Issues
- Passages API (semantic search via REST) is flaky — passages appear/disappear
- File blocks work better — loaded directly into agent context
- The `/agents/{id}/sources/` endpoint returns empty even when sources attached

### Next Steps
- Integrate Letta search into memory-router as another source
- Document usage patterns
- Test archival memory in actual agent conversations


---

## Evening Maintenance (19:09 CST)

**OpenClaw Migration Completed:**
- Upgraded clawdbot@2026.1.24-3 → openclaw@2026.2.1
- Config auto-migrated to ~/.openclaw/
- Systemd service updated
- Signal patch reapplied
- Old clawdbot package removed

**Documentation:**
- Created comprehensive OPENCLAW-STOCK.md
- Covers: stock capabilities, our custom setup, recent updates
- Deployed to Metis ~/Documents/

**Backlog Work:**
- Ran agent-audit on all 7 agents
- Fixed: arbor and akron missing facts.jsonl
- Regenerated 56 entity pages from facts
- Current facts count: 289
- All core agents healthy (clawd, syl, chiron, eiron, demiurge)

